<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pertokoan</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #9a031e 0%, #5a0000 100%);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            overflow-y: auto;
            display: none;
        }
        
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-menu {
            padding: 15px 0;
        }
        
        .sidebar-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-item:hover, .sidebar-item.active {
            background: rgba(255,255,255,0.1);
        }
        
        .sidebar-item i {
            width: 20px;
            text-align: center;
        }
        
        .sidebar-export-buttons {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: 10px;
        }
        
        .sidebar-export-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .sidebar-export-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .sidebar-export-btn i {
            width: 20px;
            text-align: center;
        }
        
        .sidebar-export-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-export-section h4 {
            margin-bottom: 10px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .main-content.with-sidebar {
            margin-left: 250px;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            width: 100%;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .menu-toggle {
            position: absolute;
            left: 15px;
            top: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: none;
        }
        
        .menu-toggle:hover {
            background: rgba(255,255,255,0.4);
        }
        
        .user-info {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info span {
            font-size: 14px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.4);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            animation: fadeIn 0.5s ease-in-out;
            width: 100%;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 5px;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #667eea;
            color: #667eea;
        }
        
        .btn-outline:hover {
            background: #667eea;
            color: white;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-width: 600px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-available {
            background: #d4edda;
            color: #155724;
        }
        
        .status-low {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-out {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        /* Card Styles */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            width: 100%;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #28a745;
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        /* Chart Container */
        .chart-container {
            height: 300px;
            margin-top: 20px;
            width: 100%;
        }
        
        /* Login Screen Animation */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .trade-icon {
            position: absolute;
            font-size: 2rem;
            color: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
            z-index: 1;
        }
        
        .trade-icon:nth-child(1) { animation-delay: 0s; }
        .trade-icon:nth-child(2) { animation-delay: 1s; }
        .trade-icon:nth-child(3) { animation-delay: 2s; }
        .trade-icon:nth-child(4) { animation-delay: 3s; }
        .trade-icon:nth-child(5) { animation-delay: 4s; }
        .trade-icon:nth-child(6) { animation-delay: 5s; }
        .trade-icon:nth-child(7) { animation-delay: 6s; }
        .trade-icon:nth-child(8) { animation-delay: 7s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }
        
        .graffiti-text {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: rgba(255, 255, 255, 0.3);
            font-size: 1.2rem;
            font-weight: bold;
            text-align: right;
            text-transform: none !important;
            z-index: 1;
        }
        
        .graffiti-text .powered-by {
            font-size: 1rem;
            margin-bottom: 2px;
            opacity: 0.7;
            text-transform: uppercase;
        }
        
        .graffiti-text .author-name {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.5);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            text-transform: none;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            position: relative;
            z-index: 2;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(0);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .login-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        
        .login-card h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 1.5rem;
        }
        
        .login-card h2 i {
            color: #667eea;
            margin-right: 10px;
        }
        
        .login-btn {
            width: 100%;
            margin-top: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        /* Input focus effects */
        .login-card input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        /* Utility Classes */
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .mt-4 {
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .supplier-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .supplier-container .form-group {
            flex: 1;
            margin-bottom: 0;
            min-width: 200px;
        }
        
        .supplier-container .btn {
            margin-bottom: 0;
        }
        
        .hidden {
            display: none;
        }
        
        .price-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .price-info p {
            margin: 5px 0;
            color: #0066cc;
        }
        
        /* Editable Field */
        .editable-field {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .editable-field input {
            width: auto;
            flex: 1;
        }
        
        /* User Management */
        .user-role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .role-owner {
            background: #d4edda;
            color: #155724;
        }
        
        .role-kasir {
            background: #cce7ff;
            color: #004085;
        }
        
        .role-manager {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Search Box */
        .search-box {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 100%;
        }
        
        /* Dark Mode */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        body.dark-mode .card,
        body.dark-mode .tab-content {
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        body.dark-mode table {
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        body.dark-mode th {
            background-color: #3d3d3d;
            color: #ffffff;
        }
        
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: #3d3d3d;
            color: #ffffff;
            border-color: #555;
        }
        
        body.dark-mode .sidebar {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }
        
        body.dark-mode header {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }
        
        /* Date Filter Styles */
        .date-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .date-filter .form-group {
            margin-bottom: 0;
            flex: 1;
            min-width: 150px;
        }
        
        .date-filter label {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        /* Firebase Status Indicator */
        .firebase-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .firebase-status.error {
            background: #dc3545;
        }
        
        .firebase-status.offline {
            background: #ffc107;
            color: #212529;
        }
        
        /* Troubleshoot Info */
        .troubleshoot-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .troubleshoot-info h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .troubleshoot-info ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .troubleshoot-info li {
            margin-bottom: 5px;
        }
        
        .admin-override {
            margin-top: 15px;
            padding: 10px;
            background: #e2e3e5;
            border-radius: 6px;
            text-align: center;
        }
        
        .admin-override button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .admin-override button:hover {
            background: #5a6268;
        }
        
        .firebase-setup-guide {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .firebase-setup-guide h4 {
            color: #0c5460;
            margin-bottom: 10px;
        }
        
        .firebase-setup-guide ol {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                transform: translateX(-100%);
            }
            
            .sidebar.hidden {
                transform: translateX(0);
            }
            
            .main-content.with-sidebar {
                margin-left: 0;
            }
            
            .main-content.expanded {
                margin-left: 0;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-row .form-group {
                min-width: 100%;
            }
            
            .supplier-container {
                flex-direction: column;
            }
            
            .supplier-container .form-group {
                min-width: 100%;
            }
            
            .user-info {
                position: static;
                justify-content: center;
                margin-top: 10px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                font-size: 12px;
                min-width: 500px;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .btn-small {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 3px;
            }
            
            .card {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 22px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            header {
                padding: 10px 0;
            }
            
            header h1 {
                font-size: 1.5rem;
                margin-top: 10px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 5px;
            }
            
            /* Responsive design for login */
            .login-card {
                margin: 20px;
                padding: 20px;
            }
            
            .trade-icon {
                font-size: 1.5rem;
            }
            
            .graffiti-text {
                font-size: 1rem;
                bottom: 10px;
                right: 10px;
            }
            
            .graffiti-text span {
                font-size: 1.2rem;
            }
            
            /* Date filter responsive */
            .date-filter {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-filter .form-group {
                min-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 10px;
            }
            
            .tab-content {
                padding: 10px;
            }
            
            table {
                font-size: 11px;
                min-width: 400px;
            }
            
            th, td {
                padding: 6px 8px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            .stat-label {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Status Indicator -->
    <div id="firebaseStatus" class="firebase-status hidden">
        <i class="fas fa-circle"></i> <span id="firebaseStatusText">Firebase</span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <!-- Ikon animasi perdagangan di latar belakang -->
        <div class="trade-icon" style="top: 20%; left: 15%;"><i class="fas fa-shopping-cart"></i></div>
        <div class="trade-icon" style="top: 40%; left: 80%;"><i class="fas fa-boxes"></i></div>
        <div class="trade-icon" style="top: 60%; left: 25%;"><i class="fas fa-cash-register"></i></div>
        <div class="trade-icon" style="top: 75%; left: 70%;"><i class="fas fa-chart-line"></i></div>
        <div class="trade-icon" style="top: 10%; left: 60%;"><i class="fas fa-tag"></i></div>
        <div class="trade-icon" style="top: 85%; left: 10%;"><i class="fas fa-truck"></i></div>
        <div class="trade-icon" style="top: 30%; left: 45%;"><i class="fas fa-dollar-sign"></i></div>
        <div class="trade-icon" style="top: 55%; left: 90%;"><i class="fas fa-receipt"></i></div>

        <!-- Teks Grafiti -->
        <div class="graffiti-text">
            <div class="powered-by">Powered by</div>
            <span class="author-name">Kim Jong Un</span>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="login-card">
            <h2><i class="fas fa-store"></i> Login Aplikasi Pertokoan</h2>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="loginEmail" placeholder="Masukkan email" autocomplete="email" value="bookingeast0@gmail.com">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" placeholder="Masukkan password" autocomplete="current-password" value="booking123">
            </div>
            <button id="loginBtn" class="btn login-btn">Login</button>
            
            <!-- Informasi Troubleshooting -->
            <div class="troubleshoot-info">
                <h4><i class="fas fa-info-circle"></i> Masalah Login?</h4>
                <ul>
                    <li>Pastikan email dan password sudah benar</li>
                    <li>Pastikan user sudah terdaftar di Firebase Authentication</li>
                    <li>Pastikan Email/Password provider sudah diaktifkan</li>
                </ul>
                <p><strong>Email yang terdaftar:</strong> bookingeast0@gmail.com</p>
            </div>
            
            <!-- Firebase Setup Guide -->
            <div class="firebase-setup-guide">
                <h4><i class="fas fa-cog"></i> Setup Firebase:</h4>
                <ol>
                    <li>Buka Firebase Console</li>
                    <li>Pilih project <strong>app-retail-e51c3</strong></li>
                    <li>Authentication → Sign-in method → Email/Password → Enable</li>
                    <li>Authentication → Users → Add user (bookingeast0@gmail.com)</li>
                </ol>
            </div>
            
            <!-- Admin Override untuk testing -->
            <div class="admin-override">
                <p><strong>Testing Mode (Jika Firebase bermasalah):</strong></p>
                <button onclick="testLogin('owner')">Login sebagai Owner</button>
                <button onclick="testLogin('manager')">Login sebagai Manager</button>
                <button onclick="testLogin('kasir')">Login sebagai Kasir</button>
            </div>
        </div>
    </div>

    <!-- Sidebar Menu -->
    <div id="sidebar" class="sidebar hidden">
        <div class="sidebar-header">
            <h2><i class="fas fa-store"></i> TokoKu</h2>
            <p>Sistem Manajemen</p>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-item active" onclick="showTab('purchase')">
                <i class="fas fa-shopping-cart"></i>
                <span>Pembelian</span>
            </div>
            <div class="sidebar-item" onclick="showTab('inventory')">
                <i class="fas fa-boxes"></i>
                <span>Persediaan</span>
            </div>
            <div class="sidebar-item" onclick="showTab('sales')">
                <i class="fas fa-cash-register"></i>
                <span>Penjualan</span>
            </div>
            <div class="sidebar-item" onclick="showTab('finance')">
                <i class="fas fa-chart-line"></i>
                <span>Keuangan</span>
            </div>
            <div class="sidebar-item" onclick="showTab('profit')">
                <i class="fas fa-calculator"></i>
                <span>Laba/Rugi</span>
            </div>
            <div class="sidebar-item" onclick="showTab('users')">
                <i class="fas fa-users"></i>
                <span>Manajemen User</span>
            </div>
            
            <!-- Export/Import Section di Sidebar -->
            <div class="sidebar-export-buttons">
                <!-- Dark Mode Button -->
                <button class="sidebar-export-btn" onclick="toggleDarkMode()">
                    <i class="fas fa-moon"></i>
                    <span>Mode Gelap</span>
                </button>
                
                <!-- Excel Export -->
                <button class="sidebar-export-btn" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i>
                    <span>Export Excel</span>
                </button>
                
                <!-- Reset Data Button -->
                <button class="sidebar-export-btn" onclick="resetAllData()">
                    <i class="fas fa-trash"></i>
                    <span>Reset Semua Data</span>
                </button>
                
                <!-- Section khusus untuk Owner -->
                <div id="ownerExportSection" class="sidebar-export-section hidden">
                    <h4>Admin Tools</h4>
                    <button class="sidebar-export-btn" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        <span>Export JSON</span>
                    </button>
                    
                    <label for="importFile" class="sidebar-export-btn" style="cursor: pointer; margin-bottom: 0;">
                        <i class="fas fa-upload"></i>
                        <span>Import Data</span>
                    </label>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="main-content" style="display: none;">
        <div class="container">
            <header>
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1><i class="fas fa-store"></i> Aplikasi Pertokoan</h1>
                <p>Sistem Manajemen Toko Terintegrasi</p>
                <div class="user-info">
                    <span id="currentUser">User</span>
                    <span id="userRole" class="user-role-badge"></span>
                    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </header>

            <!-- Tab Pembelian -->
            <div id="purchase" class="tab-content">
                <h2><i class="fas fa-shopping-cart"></i> Rencana & Pembelian</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalPurchaseMonth">Rp 0</div>
                        <div class="stat-label">Total Belanja Bulan Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalPOItems">0</div>
                        <div class="stat-label">Item dalam PO</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeSuppliers">0</div>
                        <div class="stat-label">Supplier Aktif</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Rencana Pembelian</h3>
                    <form id="purchasePlanForm">
                        <div class="form-group">
                            <label>Nama Produk:</label>
                            <input type="text" id="productName" placeholder="Masukkan nama produk" oninput="checkExistingProduct()">
                            <div id="productInfo" class="price-info hidden">
                                <p id="existingProductInfo"></p>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Kuantitas:</label>
                                <input type="number" id="quantity" placeholder="Jumlah yang dibeli" min="1">
                            </div>
                            <div class="form-group">
                                <label>Harga Satuan:</label>
                                <input type="number" id="unitPrice" placeholder="Harga per unit" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Supplier:</label>
                            <div class="supplier-container">
                                <div class="form-group">
                                    <select id="supplierSelect" onchange="handleSupplierSelect()">
                                        <option value="">Pilih Supplier</option>
                                        <option value="PT. Distributor ABC">PT. Distributor ABC</option>
                                        <option value="CV. Maju Sejahtera">CV. Maju Sejahtera</option>
                                        <option value="UD. Makmur Jaya">UD. Makmur Jaya</option>
                                        <option value="other">+ Tambah Supplier Baru</option>
                                    </select>
                                    <input type="text" id="supplierInput" class="hidden" placeholder="Masukkan nama supplier">
                                </div>
                                <button type="button" class="btn btn-outline" onclick="toggleSupplierInput()" id="toggleSupplierBtn">
                                    <i class="fas fa-edit"></i> Manual
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-plus-circle"></i> Tambah ke PO</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Daftar Supplier</h3>
                    <input type="text" class="search-box" placeholder="Cari supplier..." oninput="searchTable('supplierTable', this.value)">
                    <div class="table-container">
                        <table id="supplierTable">
                            <thead>
                                <tr>
                                    <th>Nama Supplier</th>
                                    <th>Jumlah PO</th>
                                    <th>Total Nilai PO</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Purchase Orders Aktif</h3>
                    <input type="text" class="search-box" placeholder="Cari PO..." oninput="searchTable('poTable', this.value)">
                    <div class="table-container">
                        <table id="poTable">
                            <thead>
                                <tr>
                                    <th>No. PO</th>
                                    <th>Tanggal</th>
                                    <th>Produk</th>
                                    <th>Supplier</th>
                                    <th>Kuantitas</th>
                                    <th>Harga Satuan</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab Persediaan -->
            <div id="inventory" class="tab-content">
                <h2><i class="fas fa-boxes"></i> Manajemen Persediaan</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalInventoryItems">0</div>
                        <div class="stat-label">Total Item Persediaan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lowStockItems">0</div>
                        <div class="stat-label">Item Low Stock</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalInventoryValue">Rp 0</div>
                        <div class="stat-label">Nilai Total Persediaan</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Penerimaan Barang</h3>
                    <form id="receivingForm">
                        <div class="form-group">
                            <label>Nomor PO:</label>
                            <select id="poNumber" onchange="fillReceivingForm()">
                                <option value="">Pilih Nomor PO</option>
                            </select>
                            <div class="price-info">
                                <p>Hanya menampilkan PO yang masih outstanding/aktif</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Nama Produk:</label>
                            <input type="text" id="receivedProduct" placeholder="Nama produk yang diterima" readonly>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Kuantitas PO:</label>
                                <input type="number" id="poQuantity" placeholder="Jumlah yang dipesan" readonly>
                            </div>
                            <div class="form-group">
                                <label>Kuantitas Diterima:</label>
                                <input type="number" id="receivedQuantity" placeholder="Jumlah yang diterima" min="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Harga Beli dari PO:</label>
                                <input type="number" id="poBuyPrice" placeholder="Harga beli dari PO" readonly>
                            </div>
                            <div class="form-group">
                                <label>Harga Jual Baru:</label>
                                <input type="number" id="newSellPriceReceiving" placeholder="Harga jual baru" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Kualitas:</label>
                            <select id="quality">
                                <option value="good">Baik</option>
                                <option value="damaged">Rusak</option>
                                <option value="expired">Kadaluwarsa</option>
                            </select>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-check-circle"></i> Konfirmasi Penerimaan</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Stok Produk</h3>
                    <input type="text" class="search-box" placeholder="Cari produk..." oninput="searchTable('stockTable', this.value)">
                    <div class="table-container">
                        <table id="stockTable">
                            <thead>
                                <tr>
                                    <th>Produk</th>
                                    <th>Stok</th>
                                    <th>Harga Beli</th>
                                    <th>Harga Jual</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab Penjualan - MODIFIED WITH DATE FILTER -->
            <div id="sales" class="tab-content active">
                <h2><i class="fas fa-cash-register"></i> Penjualan</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="todayTransactions">0</div>
                        <div class="stat-label">Transaksi Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todaySales">Rp 0</div>
                        <div class="stat-label">Penjualan Hari Ini</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeCustomers">0</div>
                        <div class="stat-label">Pelanggan Aktif</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Proses Penjualan</h3>
                    <form id="saleForm">
                        <div class="form-group">
                            <label>Produk:</label>
                            <select id="soldProduct">
                                <option value="">Pilih Produk</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Kuantitas:</label>
                                <input type="number" id="soldQuantity" placeholder="Jumlah terjual" min="1">
                            </div>
                            <div class="form-group">
                                <label>Diskon (%):</label>
                                <input type="number" id="discount" placeholder="Diskon" min="0" max="100" value="0">
                            </div>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-shopping-bag"></i> Tambah ke Transaksi</button>
                    </form>
                    
                    <div class="card mt-4">
                        <h4>Detail Transaksi Saat Ini</h4>
                        <div id="transactionDetails"></div>
                        <div style="margin-top: 15px;">
                            <span style="font-weight: bold;">Subtotal: </span><span id="subtotal">Rp 0</span><br>
                            <span style="font-weight: bold;">Diskon: </span><span id="discountAmount">Rp 0</span><br>
                            <span style="font-weight: bold;">Total: </span><span id="totalAmount">Rp 0</span>
                        </div>
                        <div class="action-buttons" style="margin-top: 15px;">
                            <button type="button" class="btn btn-secondary" onclick="clearTransaction()">
                                <i class="fas fa-times"></i> Batalkan Transaksi
                            </button>
                            <button type="button" class="btn btn-success" onclick="completeTransaction()">
                                <i class="fas fa-check-double"></i> Selesaikan Transaksi
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Riwayat Penjualan</h3>
                    
                    <!-- Date Filter Section -->
                    <div class="date-filter">
                        <div class="form-group">
                            <label>Tanggal Mulai:</label>
                            <input type="date" id="startDate" onchange="loadSalesFromFirebase()">
                        </div>
                        <div class="form-group">
                            <label>Tanggal Akhir:</label>
                            <input type="date" id="endDate" onchange="loadSalesFromFirebase()">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-secondary" onclick="resetDateFilter()">
                                <i class="fas fa-refresh"></i> Reset Filter
                            </button>
                        </div>
                    </div>
                    
                    <input type="text" class="search-box" placeholder="Cari penjualan..." oninput="searchTable('salesTable', this.value)">
                    <div class="table-container">
                        <table id="salesTable">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Produk</th>
                                    <th>Jumlah</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th id="salesActionHeader" class="hidden">Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab Keuangan -->
            <div id="finance" class="tab-content">
                <h2><i class="fas fa-chart-line"></i> Keuangan</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="cashBalance">Rp 0</div>
                        <div class="stat-label">Saldo Kas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="customerReceivables">Rp 0</div>
                        <div class="stat-label">Piutang Pelanggan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="supplierPayables">Rp 0</div>
                        <div class="stat-label">Hutang Supplier</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Pemasukan</h3>
                    <form id="incomeForm">
                        <div class="form-group">
                            <label>Sumber Dana:</label>
                            <select id="incomeSource">
                                <option value="sales">Penjualan</option>
                                <option value="investment">Investasi</option>
                                <option value="loan">Pinjaman</option>
                                <option value="other">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Jumlah:</label>
                            <input type="number" id="incomeAmount" placeholder="Jumlah pemasukan" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Keterangan:</label>
                            <textarea id="incomeDescription" rows="3" placeholder="Deskripsi pemasukan"></textarea>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-plus"></i> Catat Pemasukan</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Pengeluaran</h3>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label>Jenis Pengeluaran:</label>
                            <select id="expenseType">
                                <option value="purchase">Pembelian Barang</option>
                                <option value="operational">Operasional</option>
                                <option value="salary">Gaji Karyawan</option>
                                <option value="utility">Tagihan Utilitas</option>
                                <option value="other">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Jumlah:</label>
                            <input type="number" id="expenseAmount" placeholder="Jumlah pengeluaran" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Keterangan:</label>
                            <textarea id="expenseDescription" rows="3" placeholder="Deskripsi pengeluaran"></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger"><i class="fas fa-minus"></i> Catat Pengeluaran</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Biaya Utilitas</h3>
                    <form id="utilityForm">
                        <div class="form-group">
                            <label>Jenis Utilitas:</label>
                            <select id="utilityType">
                                <option value="electricity">Listrik</option>
                                <option value="water">Air</option>
                                <option value="internet">Internet</option>
                                <option value="phone">Telepon</option>
                                <option value="rent">Sewa</option>
                                <option value="other">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Periode:</label>
                            <input type="month" id="utilityPeriod">
                        </div>
                        <div class="form-group">
                            <label>Jumlah:</label>
                            <input type="number" id="utilityAmount" placeholder="Jumlah biaya utilitas" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Keterangan:</label>
                            <textarea id="utilityDescription" rows="3" placeholder="Deskripsi biaya utilitas"></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger"><i class="fas fa-bolt"></i> Catat Biaya Utilitas</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Laporan Keuangan</h3>
                    <div class="chart-container">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tab Laba/Rugi -->
            <div id="profit" class="tab-content">
                <h2><i class="fas fa-calculator"></i> Perhitungan Laba/Rugi</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRevenue">Rp 0</div>
                        <div class="stat-label">Total Pendapatan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCost">Rp 0</div>
                        <div class="stat-label">Total Biaya</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="netProfit">Rp 0</div>
                        <div class="stat-label">Laba Bersih</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Hitung Laba/Rugi</h3>
                    <form id="profitForm">
                        <div class="form-group">
                            <label>Periode:</label>
                            <select id="period">
                                <option value="daily">Harian</option>
                                <option value="weekly">Mingguan</option>
                                <option value="monthly">Bulanan</option>
                                <option value="yearly">Tahunan</option>
                            </select>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-chart-pie"></i> Hitung Laba</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Ringkasan Laba/Rugi</h3>
                    <div class="table-container">
                        <table id="profitTable">
                            <thead>
                                <tr>
                                    <th>Komponen</th>
                                    <th>Jumlah (Rp)</th>
                                    <th>Persen (%)</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Total Pendapatan Penjualan</td>
                                    <td id="profitTotalRevenue">0</td>
                                    <td id="revenuePercent">0%</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>Biaya Beli Barang</td>
                                    <td id="profitCostOfGoodsSold">0</td>
                                    <td id="cogsPercent">0%</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="editCost('cogs')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Biaya Operasional</td>
                                    <td id="profitOperationalCost">0</td>
                                    <td id="opexPercent">0%</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="editCost('operational')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Biaya Gaji Karyawan</td>
                                    <td id="profitSalaryCost">0</td>
                                    <td id="salaryPercent">0%</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="editCost('salary')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Biaya Utilitas</td>
                                    <td id="profitUtilityCost">0</td>
                                    <td id="utilityPercent">0%</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="editCost('utility')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Biaya Lain-lain</td>
                                    <td id="profitOtherCost">0</td>
                                    <td id="otherPercent">0%</td>
                                    <td>
                                        <button class="btn btn-small btn-secondary" onclick="editCost('other')">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Biaya</strong></td>
                                    <td id="profitTotalCost">0</td>
                                    <td id="totalCostPercent">0%</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td><strong>Laba/Rugi Bersih</strong></td>
                                    <td id="profitNetProfit">0</td>
                                    <td id="netProfitPercent">0%</td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Grafik Laba/Rugi</h3>
                    <div class="chart-container">
                        <canvas id="profitChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tab Manajemen User -->
            <div id="users" class="tab-content">
                <h2><i class="fas fa-users"></i> Manajemen User</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total User</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">User Aktif</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="adminUsers">0</div>
                        <div class="stat-label">User Admin</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Tambah User Baru</h3>
                    <form id="userForm">
                        <div class="form-group">
                            <label>Nama Lengkap:</label>
                            <input type="text" id="fullName" placeholder="Masukkan nama lengkap">
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="newEmail" placeholder="Masukkan email">
                        </div>
                        <div class="form-group">
                            <label>Password:</label>
                            <input type="password" id="newPassword" placeholder="Masukkan password">
                        </div>
                        <div class="form-group">
                            <label>Konfirmasi Password:</label>
                            <input type="password" id="confirmPassword" placeholder="Konfirmasi password">
                        </div>
                        <div class="form-group">
                            <label>Role:</label>
                            <select id="userRoleSelect">
                                <option value="kasir">Kasir</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-user-plus"></i> Tambah User</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Daftar User</h3>
                    <input type="text" class="search-box" placeholder="Cari user..." oninput="searchTable('usersTable', this.value)">
                    <div class="table-container">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // ================= FIREBASE CONFIGURATION =================
        const firebaseConfig = {
            apiKey: "AIzaSyAoDQMkiL4VrWUGiECcyvDj9VOWavRM2eY",
            authDomain: "app-retail-e51c3.firebaseapp.com",
            projectId: "app-retail-e51c3",
            storageBucket: "app-retail-e51c3.firebasestorage.app",
            messagingSenderId: "320980794037",
            appId: "1:320980794037:web:96668d2996db5a15079cfc",
            measurementId: "G-DBTRJTGES2"
        };

        // Initialize Firebase
        let db, auth;
        let firebaseInitialized = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            firebaseInitialized = true;
            updateFirebaseStatus('Firebase Terhubung', 'success');
            console.log('Firebase initialized successfully');
            
            // Check auth state
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    console.log('User logged in:', user.email);
                    handleSuccessfulLogin(user);
                } else {
                    // User is signed out
                    console.log('User signed out');
                }
            });
            
        } catch (error) {
            console.error('Firebase initialization error:', error);
            updateFirebaseStatus('Gagal Terhubung ke Firebase', 'error');
            showNotification('Error: Gagal terhubung ke database Firebase', true);
        }

        // Handle successful login
        async function handleSuccessfulLogin(user) {
            let userData = await loadUserData(user.uid);
            
            if (!userData) {
                // User data not found in Firestore, create default
                console.log('User data not found, creating default...');
                userData = await createDefaultUserData(user);
            }
            
            if (userData) {
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    ...userData
                };
                
                document.getElementById('currentUser').textContent = userData.fullName || user.email;
                
                // Set user role badge
                const userRoleElement = document.getElementById('userRole');
                userRoleElement.textContent = userData.role;
                userRoleElement.className = `user-role-badge role-${userData.role}`;
                
                // Hide login screen, show app
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Show sidebar after login
                const sidebar = document.getElementById('sidebar');
                sidebar.style.display = 'block';
                sidebar.classList.remove('hidden');
                
                // Add margin to main content
                const mainContent = document.querySelector('.main-content');
                mainContent.classList.add('with-sidebar');
                
                // Show menu toggle button
                document.querySelector('.menu-toggle').style.display = 'block';
                
                // Set up UI based on user role
                setupUserInterface();
                
                // Initialize data after login
                updateAllStats();
                initializeCharts();
                
                // Load sales data from Firebase
                loadSalesFromFirebase().then(sales => {
                    salesTransactions = sales;
                    updateSalesTable();
                });
                
                showNotification(`Login sebagai ${userData.fullName || user.email} berhasil`);
            }
        }

        // Create default user data if not exists
        async function createDefaultUserData(user) {
            if (!db) {
                console.error('Firestore not available');
                return null;
            }
            
            try {
                const userData = {
                    fullName: user.email.split('@')[0],
                    email: user.email,
                    role: 'owner', // Default role
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(user.uid).set(userData);
                console.log('Default user data created for:', user.email);
                return userData;
            } catch (error) {
                console.error('Error creating default user data:', error);
                return null;
            }
        }

        // Firebase status indicator
        function updateFirebaseStatus(message, type = 'success') {
            const statusEl = document.getElementById('firebaseStatus');
            const statusText = document.getElementById('firebaseStatusText');
            
            if (statusEl && statusText) {
                statusText.textContent = message;
                statusEl.className = `firebase-status ${type}`;
                statusEl.classList.remove('hidden');
            }
        }

        // ================= FIREBASE AUTHENTICATION FUNCTIONS =================
        
        // Login with email and password
        async function loginWithEmail(email, password) {
            if (!auth) {
                showNotification('Firebase Auth tidak tersedia', true);
                return null;
            }
            
            try {
                console.log('Attempting login with:', email);
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Login successful:', userCredential.user.email);
                return userCredential.user;
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Terjadi kesalahan saat login';
                
                switch(error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'Format email tidak valid';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Akun ini telah dinonaktifkan';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'Email tidak terdaftar di sistem';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Password salah';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Koneksi jaringan bermasalah';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showNotification(errorMessage, true);
                return null;
            }
        }

        // Register new user
        async function registerWithEmail(email, password, userData) {
            if (!auth || !db) {
                showNotification('Firebase tidak tersedia', true);
                return null;
            }
            
            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Save user data to Firestore
                await db.collection('users').doc(user.uid).set({
                    ...userData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return user;
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Terjadi kesalahan saat pendaftaran';
                
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email sudah digunakan';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Format email tidak valid';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password terlalu lemah (minimal 6 karakter)';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showNotification(errorMessage, true);
                return null;
            }
        }

        // Load user data from Firestore
        async function loadUserData(uid) {
            if (!db) {
                console.error('Firestore not available');
                return null;
            }
            
            try {
                const doc = await db.collection('users').doc(uid).get();
                if (doc.exists) {
                    return doc.data();
                } else {
                    console.log('No user data found in Firestore');
                    return null;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        // ================= TESTING FUNCTIONS =================
        
        // Test login function for development
        function testLogin(role) {
            console.log('Test login as:', role);
            
            // Create test user data
            const testUsers = {
                owner: {
                    uid: 'test-owner-001',
                    email: 'bookingeast0@gmail.com',
                    fullName: 'Pemilik Toko',
                    role: 'owner',
                    status: 'active'
                },
                manager: {
                    uid: 'test-manager-001',
                    email: 'manager@toko.com',
                    fullName: 'Manager Toko',
                    role: 'manager',
                    status: 'active'
                },
                kasir: {
                    uid: 'test-kasir-001',
                    email: 'kasir@toko.com',
                    fullName: 'Kasir Toko',
                    role: 'kasir',
                    status: 'active'
                }
            };
            
            const testUser = testUsers[role];
            if (!testUser) return;
            
            currentUser = testUser;
            document.getElementById('currentUser').textContent = testUser.fullName;
            
            // Set user role badge
            const userRoleElement = document.getElementById('userRole');
            userRoleElement.textContent = testUser.role;
            userRoleElement.className = `user-role-badge role-${testUser.role}`;
            
            // Hide login screen, show app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            // Show sidebar after login
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = 'block';
            sidebar.classList.remove('hidden');
            
            // Add margin to main content
            const mainContent = document.querySelector('.main-content');
            mainContent.classList.add('with-sidebar');
            
            // Show menu toggle button
            document.querySelector('.menu-toggle').style.display = 'block';
            
            // Set up UI based on user role
            setupUserInterface();
            
            // Initialize data after login
            updateAllStats();
            initializeCharts();
            
            showNotification(`Login sebagai ${testUser.fullName} berhasil (Testing Mode)`);
        }

        // ================= FIREBASE FIRESTORE FUNCTIONS =================
        
        // Save sales transaction to Firebase
        async function saveSalesToFirebase(sale) {
            if (!db) {
                console.error('Firebase not initialized');
                return null;
            }
            
            try {
                const docRef = await db.collection('sales').add({
                    ...sale,
                    userId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('Sales transaction saved with ID:', docRef.id);
                updateFirebaseStatus('Data Tersimpan', 'success');
                return docRef.id;
            } catch (error) {
                console.error('Error saving sales transaction:', error);
                updateFirebaseStatus('Gagal Simpan', 'error');
                return null;
            }
        }

        // Load sales from Firebase with date filter
        async function loadSalesFromFirebase() {
            if (!db) {
                console.error('Firebase not initialized');
                return [];
            }
            
            try {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                let query = db.collection('sales').orderBy('date', 'desc');
                
                // Apply date filter if provided
                if (startDateInput && startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    query = query.where('date', '>=', startDate);
                }
                
                if (endDateInput && endDateInput.value) {
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(23, 59, 59, 999); // End of the day
                    query = query.where('date', '<=', endDate);
                }
                
                const snapshot = await query.get();
                const sales = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    sales.push({
                        id: doc.id,
                        ...data,
                        // Convert Firestore timestamp to Date object
                        date: data.date?.toDate ? data.date.toDate() : new Date(data.date)
                    });
                });
                
                updateFirebaseStatus('Data Dimuat', 'success');
                return sales;
            } catch (error) {
                console.error('Error loading sales:', error);
                updateFirebaseStatus('Gagal Muat Data', 'error');
                return [];
            }
        }

        // Delete sales transaction from Firebase
        async function deleteSalesFromFirebase(id) {
            if (!db) {
                console.error('Firebase not initialized');
                return false;
            }
            
            try {
                await db.collection('sales').doc(id).delete();
                updateFirebaseStatus('Data Dihapus', 'success');
                return true;
            } catch (error) {
                console.error('Error deleting sales transaction:', error);
                updateFirebaseStatus('Gagal Hapus', 'error');
                return false;
            }
        }

        // ================= DATA STORAGE =================
        let purchaseOrders = [];
        let inventory = [];
        let salesTransactions = [];
        let incomeRecords = [];
        let expenseRecords = [];
        let utilityRecords = [];
        let suppliers = [];
        let users = [];
        
        let currentTransactionItems = [];
        let currentUser = null;

        // ================= FUNGSI UTAMA =================

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set up login
            document.getElementById('loginBtn').addEventListener('click', login);
            
            // Enter key support for login
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            document.getElementById('loginEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('loginPassword').focus();
                }
            });
            
            // Load data
            loadMinimalSampleData();
            loadAutoSave();
            
            // Setup form event listeners
            setupFormListeners();
            
            // Handle responsive design
            handleResize();
            
            // Load dark mode preference
            loadDarkModePreference();
            
            // Set default dates for filter
            const today = new Date();
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(today.getDate() - 7);
            
            document.getElementById('startDate').valueAsDate = oneWeekAgo;
            document.getElementById('endDate').valueAsDate = today;
        });

        // Login function
        async function login() {
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.textContent;
            
            // Show loading state
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            loginBtn.disabled = true;
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showNotification('Harap masukkan email dan password!', true);
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                return;
            }
            
            const user = await loginWithEmail(email, password);
            
            // Reset login button
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        }

        // Logout function
        function logout() {
            if (auth) {
                auth.signOut().then(() => {
                    currentUser = null;
                    
                    // Hide app and sidebar, show login screen
                    document.getElementById('app').style.display = 'none';
                    document.getElementById('sidebar').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                    
                    // Reset form
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                    
                    showNotification('Logout berhasil');
                }).catch((error) => {
                    console.error('Logout error:', error);
                    showNotification('Error saat logout', true);
                });
            } else {
                // Fallback logout for test users
                currentUser = null;
                document.getElementById('app').style.display = 'none';
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                showNotification('Logout berhasil');
            }
        }

        // Reset date filter
        function resetDateFilter() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';
            
            loadSalesFromFirebase().then(sales => {
                salesTransactions = sales;
                updateSalesTable();
                showNotification('Filter tanggal direset');
            });
        }

        // Setup UI based on user role
        function setupUserInterface() {
            const ownerExportSection = document.getElementById('ownerExportSection');
            const salesActionHeader = document.getElementById('salesActionHeader');
            const userManagementTab = document.querySelector('.sidebar-item[onclick="showTab(\'users\')"]');
            
            // Hide owner export section by default
            ownerExportSection.classList.add('hidden');
            salesActionHeader.classList.add('hidden');
            
            // Show tabs based on user role
            if (currentUser.role === 'kasir') {
                // Kasir tidak bisa akses export/import JSON dan manajemen user
                ownerExportSection.classList.add('hidden');
                salesActionHeader.classList.add('hidden');
                userManagementTab.style.display = 'none';
                
                // Show only sales tab
                showTab('sales');
            } else if (currentUser.role === 'owner') {
                // Owner bisa akses semua fitur export/import
                ownerExportSection.classList.remove('hidden');
                salesActionHeader.classList.remove('hidden');
                userManagementTab.style.display = 'flex';
            } else if (currentUser.role === 'manager') {
                // Manager tidak bisa akses export/import JSON, tapi bisa akses manajemen user
                ownerExportSection.classList.add('hidden');
                salesActionHeader.classList.remove('hidden');
                userManagementTab.style.display = 'flex';
            }
        }

        // Complete Transaction with Firebase
        async function completeTransaction() {
            if (currentTransactionItems.length === 0) {
                showNotification('Belum ada item di transaksi!', true);
                return;
            }
            
            const totalAmount = currentTransactionItems.reduce((sum, item) => sum + item.total, 0);
            
            const sale = {
                id: Date.now().toString(),
                date: new Date(),
                items: [...currentTransactionItems],
                total: totalAmount,
                status: 'completed'
            };
            
            // Save to Firebase
            const firebaseId = await saveSalesToFirebase(sale);
            
            if (firebaseId) {
                // Update local ID with Firebase ID
                sale.id = firebaseId;
                
                // Add to local array
                salesTransactions.push(sale);
                
                // Add to income records
                incomeRecords.push({
                    id: Date.now(),
                    date: new Date(),
                    source: 'sales',
                    amount: totalAmount,
                    description: 'Penjualan produk: ' + currentTransactionItems.map(item => item.product).join(', ')
                });
                
                // Clear current transaction
                currentTransactionItems = [];
                updateTransactionDetails();
                
                showNotification('Transaksi selesai dan tersimpan di cloud!');
            } else {
                showNotification('Gagal menyimpan transaksi ke cloud!', true);
            }
        }

        // Clear Transaction
        function clearTransaction() {
            if (currentTransactionItems.length === 0) {
                showNotification('Tidak ada transaksi yang sedang berlangsung!', true);
                return;
            }
            
            // Restore stock for all items in current transaction
            currentTransactionItems.forEach(item => {
                const product = inventory.find(p => p.name === item.product);
                if (product) {
                    product.stock += item.quantity;
                }
            });
            
            currentTransactionItems = [];
            updateTransactionDetails();
            
            showNotification('Transaksi dibatalkan');
        }

        // Business calculations
        function getTotalRevenue() {
            return salesTransactions.reduce((sum, sale) => sum + sale.total, 0);
        }

        function getTotalCost() {
            return purchaseOrders.reduce((sum, po) => sum + po.total, 0) +
                   expenseRecords.filter(exp => exp.type !== 'purchase').reduce((sum, exp) => sum + exp.amount, 0) +
                   utilityRecords.reduce((sum, util) => sum + util.amount, 0);
        }

        function getCOGS() {
            return purchaseOrders.reduce((sum, po) => sum + po.total, 0);
        }

        function getSalaryCost() {
            return expenseRecords.filter(exp => exp.type === 'salary').reduce((sum, exp) => sum + exp.amount, 0);
        }

        function getUtilityCost() {
            return utilityRecords.reduce((sum, util) => sum + util.amount, 0);
        }

        function calculateProfit() {
            const revenue = getTotalRevenue();
            const cogs = getCOGS();
            const operationalCost = expenseRecords.filter(exp => exp.type === 'operational').reduce((sum, exp) => sum + exp.amount, 0);
            const salaryCost = getSalaryCost();
            const utilityCost = getUtilityCost();
            const otherCost = expenseRecords.filter(exp => !['purchase', 'operational', 'salary', 'utility'].includes(exp.type)).reduce((sum, exp) => sum + exp.amount, 0);
            const totalCost = cogs + operationalCost + salaryCost + utilityCost + otherCost;
            const netProfit = revenue - totalCost;
            
            document.getElementById('profitTotalRevenue').textContent = formatCurrency(revenue);
            document.getElementById('profitCostOfGoodsSold').textContent = formatCurrency(cogs);
            document.getElementById('profitOperationalCost').textContent = formatCurrency(operationalCost);
            document.getElementById('profitSalaryCost').textContent = formatCurrency(salaryCost);
            document.getElementById('profitUtilityCost').textContent = formatCurrency(utilityCost);
            document.getElementById('profitOtherCost').textContent = formatCurrency(otherCost);
            document.getElementById('profitTotalCost').textContent = formatCurrency(totalCost);
            document.getElementById('profitNetProfit').textContent = formatCurrency(netProfit);
            
            // Calculate percentages
            const revenuePercent = revenue > 0 ? ((revenue - totalCost) / revenue * 100).toFixed(1) : 0;
            document.getElementById('revenuePercent').textContent = `${revenuePercent}%`;
            
            const cogsPercent = revenue > 0 ? (cogs / revenue * 100).toFixed(1) : 0;
            document.getElementById('cogsPercent').textContent = `${cogsPercent}%`;
            
            const opexPercent = revenue > 0 ? (operationalCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('opexPercent').textContent = `${opexPercent}%`;
            
            const salaryPercent = revenue > 0 ? (salaryCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('salaryPercent').textContent = `${salaryPercent}%`;
            
            const utilityPercent = revenue > 0 ? (utilityCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('utilityPercent').textContent = `${utilityPercent}%`;
            
            const otherPercent = revenue > 0 ? (otherCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('otherPercent').textContent = `${otherPercent}%`;
            
            const totalCostPercent = revenue > 0 ? (totalCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('totalCostPercent').textContent = `${totalCostPercent}%`;
            
            const netProfitPercent = revenue > 0 ? (netProfit / revenue * 100).toFixed(1) : 0;
            document.getElementById('netProfitPercent').textContent = `${netProfitPercent}%`;
            
            // Update profit chart
            updateProfitChart();
        }

        // Chart initialization
        function initializeCharts() {
            // Finance chart
            const financeCtx = document.getElementById('financeChart');
            if (!financeCtx) return;
            
            const financeCanvas = financeCtx.getContext('2d');
            window.financeChart = new Chart(financeCanvas, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pemasukan',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Pengeluaran',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Fluktuasi Keuangan'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Profit chart
            const profitCtx = document.getElementById('profitChart');
            if (!profitCtx) return;
            
            const profitCanvas = profitCtx.getContext('2d');
            window.profitChart = new Chart(profitCanvas, {
                type: 'bar',
                data: {
                    labels: ['Pendapatan Penjualan', 'Biaya Beli Barang', 'Biaya Operasional', 'Biaya Gaji', 'Biaya Utilitas', 'Biaya Lain-lain'],
                    datasets: [{
                        label: 'Jumlah (Rp)',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#fd7e14', '#17a2b8', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Komposisi Biaya vs Pendapatan'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Update charts with initial data
            updateFinanceChart();
            updateProfitChart();
        }

        function updateFinanceChart() {
            if (!window.financeChart) return;
            
            const dates = [...new Set([...incomeRecords, ...expenseRecords].map(record => formatDate(record.date)))].sort();
            const incomes = dates.map(date => 
                incomeRecords.filter(record => formatDate(record.date) === date)
                    .reduce((sum, record) => sum + record.amount, 0)
            );
            const expenses = dates.map(date => 
                expenseRecords.filter(record => formatDate(record.date) === date)
                    .reduce((sum, record) => sum + record.amount, 0)
            );
            
            window.financeChart.data.labels = dates;
            window.financeChart.data.datasets[0].data = incomes;
            window.financeChart.data.datasets[1].data = expenses;
            window.financeChart.update();
        }

        function updateProfitChart() {
            if (!window.profitChart) return;
            
            const revenue = getTotalRevenue();
            const cogs = getCOGS();
            const operationalCost = expenseRecords.filter(exp => exp.type === 'operational').reduce((sum, exp) => sum + exp.amount, 0);
            const salaryCost = getSalaryCost();
            const utilityCost = getUtilityCost();
            const otherCost = expenseRecords.filter(exp => !['purchase', 'operational', 'salary', 'utility'].includes(exp.type)).reduce((sum, exp) => sum + exp.amount, 0);
            
            window.profitChart.data.datasets[0].data = [revenue, cogs, operationalCost, salaryCost, utilityCost, otherCost];
            window.profitChart.update();
        }

        // Additional functionality
        function toggleSupplierInput() {
            const supplierSelect = document.getElementById('supplierSelect');
            const supplierInput = document.getElementById('supplierInput');
            const toggleBtn = document.getElementById('toggleSupplierBtn');
            
            if (!supplierSelect || !supplierInput || !toggleBtn) return;
            
            if (supplierInput.classList.contains('hidden')) {
                // Switch to manual input
                supplierSelect.classList.add('hidden');
                supplierInput.classList.remove('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-list"></i> Pilih';
                supplierInput.focus();
            } else {
                // Switch back to select
                supplierSelect.classList.remove('hidden');
                supplierInput.classList.add('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-edit"></i> Manual';
                supplierInput.value = '';
            }
        }

        function handleSupplierSelect() {
            const supplierSelect = document.getElementById('supplierSelect');
            if (supplierSelect && supplierSelect.value === 'other') {
                toggleSupplierInput();
            }
        }

        function updateSupplierSelect() {
            const supplierSelect = document.getElementById('supplierSelect');
            if (!supplierSelect) return;
            
            // Save current value
            const currentValue = supplierSelect.value;
            
            // Remove all options except the first and the "other" option
            while (supplierSelect.children.length > 2) {
                supplierSelect.removeChild(supplierSelect.lastChild);
            }
            
            // Add supplier options
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierSelect.appendChild(option);
            });
            
            // Restore previous value if it still exists
            if (suppliers.includes(currentValue)) {
                supplierSelect.value = currentValue;
            }
        }

        function checkExistingProduct() {
            const productName = document.getElementById('productName').value.trim();
            const productInfo = document.getElementById('productInfo');
            const existingProductInfo = document.getElementById('existingProductInfo');
            
            if (!productName || !productInfo || !existingProductInfo) {
                return;
            }
            
            if (!productName) {
                productInfo.classList.add('hidden');
                return;
            }
            
            // Check if product exists in inventory
            const existingProduct = inventory.find(item => 
                item.name.toLowerCase().includes(productName.toLowerCase())
            );
            
            if (existingProduct) {
                existingProductInfo.innerHTML = `
                    <strong>Produk ditemukan:</strong> ${existingProduct.name}<br>
                    <strong>Stok saat ini:</strong> ${existingProduct.stock} unit<br>
                    <strong>Harga beli terakhir:</strong> ${formatCurrency(existingProduct.buyPrice)}<br>
                    <strong>Harga jual saat ini:</strong> ${formatCurrency(existingProduct.sellPrice)}
                `;
                productInfo.classList.remove('hidden');
                
                // Auto-fill unit price with last purchase price
                document.getElementById('unitPrice').value = existingProduct.buyPrice;
            } else {
                // Check if there are recent POs for this product
                const recentPOs = purchaseOrders
                    .filter(po => po.product.toLowerCase().includes(productName.toLowerCase()))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (recentPOs.length > 0) {
                    const latestPO = recentPOs[0];
                    existingProductInfo.innerHTML = `
                        <strong>Produk belum ada di inventory, tetapi ada PO sebelumnya:</strong><br>
                        <strong>PO Terakhir:</strong> ${latestPO.poNumber} (${formatDate(latestPO.date)})<br>
                        <strong>Harga beli terakhir:</strong> ${formatCurrency(latestPO.price)}<br>
                        <strong>Supplier:</strong> ${latestPO.supplier}
                    `;
                    productInfo.classList.remove('hidden');
                    
                    // Auto-fill unit price with last PO price
                    document.getElementById('unitPrice').value = latestPO.price;
                } else {
                    productInfo.classList.add('hidden');
                }
            }
        }

        function editProduct(id) {
            const product = inventory.find(p => p.id === id);
            if (product) {
                const newBuyPrice = prompt(`Edit harga beli untuk ${product.name}:`, product.buyPrice);
                const newSellPrice = prompt(`Edit harga jual untuk ${product.name}:`, product.sellPrice);
                
                if (newBuyPrice && !isNaN(newBuyPrice) && newSellPrice && !isNaN(newSellPrice)) {
                    product.buyPrice = parseFloat(newBuyPrice);
                    product.sellPrice = parseFloat(newSellPrice);
                    
                    showNotification(`Harga ${product.name} diperbarui`);
                }
            }
        }

        function deleteProduct(id) {
            const product = inventory.find(p => p.id === id);
            if (product) {
                const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus produk ${product.name}?`);
                if (confirmDelete) {
                    const index = inventory.findIndex(p => p.id === id);
                    if (index !== -1) {
                        inventory.splice(index, 1);
                        showNotification(`Produk ${product.name} berhasil dihapus`);
                    }
                }
            }
        }

        function deleteSupplier(supplierName) {
            // Check if supplier has active POs
            const activePOs = purchaseOrders.filter(po => po.supplier === supplierName && po.status === 'pending');
            
            if (activePOs.length > 0) {
                showNotification(`Tidak dapat menghapus supplier ${supplierName} karena masih memiliki PO aktif!`, true);
                return;
            }
            
            const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus supplier ${supplierName}?`);
            if (confirmDelete) {
                const index = suppliers.findIndex(s => s === supplierName);
                if (index !== -1) {
                    suppliers.splice(index, 1);
                    showNotification(`Supplier ${supplierName} berhasil dihapus`);
                }
            }
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                const newFullName = prompt(`Edit nama lengkap untuk ${user.username}:`, user.fullName);
                const newRole = prompt(`Edit role untuk ${user.username} (owner/kasir/manager):`, user.role);
                const newStatus = prompt(`Edit status untuk ${user.username} (active/inactive):`, user.status);
                
                if (newFullName && newRole && newStatus) {
                    user.fullName = newFullName;
                    user.role = newRole;
                    user.status = newStatus;
                    
                    showNotification(`User ${user.username} berhasil diperbarui`);
                }
            }
        }

        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                // Prevent deleting current user
                if (currentUser && currentUser.id === id) {
                    showNotification('Tidak dapat menghapus user yang sedang login!', true);
                    return;
                }
                
                const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus user ${user.fullName}?`);
                if (confirmDelete) {
                    const index = users.findIndex(u => u.id === id);
                    if (index !== -1) {
                        users.splice(index, 1);
                        showNotification(`User ${user.fullName} berhasil dihapus`);
                    }
                }
            }
        }

        function editCost(costType) {
            let currentValue = 0;
            let costName = '';
            
            switch(costType) {
                case 'cogs':
                    currentValue = getCOGS();
                    costName = 'Biaya Beli Barang';
                    break;
                case 'operational':
                    currentValue = expenseRecords.filter(exp => exp.type === 'operational').reduce((sum, exp) => sum + exp.amount, 0);
                    costName = 'Biaya Operasional';
                    break;
                case 'salary':
                    currentValue = getSalaryCost();
                    costName = 'Biaya Gaji Karyawan';
                    break;
                case 'utility':
                    currentValue = getUtilityCost();
                    costName = 'Biaya Utilitas';
                    break;
                case 'other':
                    currentValue = expenseRecords.filter(exp => !['purchase', 'operational', 'salary', 'utility'].includes(exp.type)).reduce((sum, exp) => sum + exp.amount, 0);
                    costName = 'Biaya Lain-lain';
                    break;
            }
            
            const newValue = prompt(`Edit ${costName}:`, currentValue);
            
            if (newValue && !isNaN(newValue)) {
                const amount = parseFloat(newValue);
                
                // Update the corresponding records
                switch(costType) {
                    case 'cogs':
                        expenseRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'purchase',
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                    case 'operational':
                        expenseRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'operational',
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                    case 'salary':
                        expenseRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'salary',
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                    case 'utility':
                        utilityRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'other',
                            period: new Date().toISOString().slice(0, 7),
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                    case 'other':
                        expenseRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'other',
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                }
                
                showNotification(`${costName} berhasil diperbarui`);
            }
        }

        // Search functionality
        function searchTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            });
        }

        // Export to Excel
        function exportToExcel() {
            if (!currentUser) {
                showNotification('Harap login terlebih dahulu!', true);
                return;
            }
            
            try {
                // Create workbook
                const workbook = XLSX.utils.book_new();
                
                // Worksheet untuk Purchase Orders
                const poData = purchaseOrders.map(po => ({
                    'No. PO': po.poNumber,
                    'Tanggal': formatDate(po.date),
                    'Produk': po.product,
                    'Supplier': po.supplier,
                    'Kuantitas': po.quantity,
                    'Harga Satuan': po.price,
                    'Total': po.total,
                    'Status': po.status === 'pending' ? 'Menunggu' : 'Selesai'
                }));
                if (poData.length > 0) {
                    const poWorksheet = XLSX.utils.json_to_sheet(poData);
                    XLSX.utils.book_append_sheet(workbook, poWorksheet, 'Purchase Orders');
                }
                
                // Worksheet untuk Inventory
                const inventoryData = inventory.map(item => ({
                    'Produk': item.name,
                    'Stok': item.stock,
                    'Harga Beli': item.buyPrice,
                    'Harga Jual': item.sellPrice,
                    'Status': item.stock <= 10 ? 'Kosong' : (item.stock <= 20 ? 'Stok Rendah' : 'Tersedia')
                }));
                if (inventoryData.length > 0) {
                    const inventoryWorksheet = XLSX.utils.json_to_sheet(inventoryData);
                    XLSX.utils.book_append_sheet(workbook, inventoryWorksheet, 'Persediaan');
                }
                
                // Worksheet untuk Penjualan
                const salesData = salesTransactions.map(sale => ({
                    'Tanggal': formatDate(sale.date),
                    'Produk': sale.items.map(item => item.product).join(', '),
                    'Jumlah Total': sale.items.reduce((sum, item) => sum + item.quantity, 0),
                    'Total Penjualan': sale.total,
                    'Status': 'Selesai'
                }));
                if (salesData.length > 0) {
                    const salesWorksheet = XLSX.utils.json_to_sheet(salesData);
                    XLSX.utils.book_append_sheet(workbook, salesWorksheet, 'Penjualan');
                }
                
                // Worksheet untuk Keuangan
                const totalIncome = incomeRecords.reduce((sum, inc) => sum + inc.amount, 0);
                const totalExpense = expenseRecords.reduce((sum, exp) => sum + exp.amount, 0);
                const totalUtility = utilityRecords.reduce((sum, util) => sum + util.amount, 0);
                const cashBalance = totalIncome - totalExpense - totalUtility;
                
                const financeData = [
                    { 'Jenis': 'Total Pemasukan', 'Jumlah': totalIncome },
                    { 'Jenis': 'Total Pengeluaran', 'Jumlah': totalExpense },
                    { 'Jenis': 'Total Biaya Utilitas', 'Jumlah': totalUtility },
                    { 'Jenis': 'Saldo Kas', 'Jumlah': cashBalance },
                    { 'Jenis': 'Piutang Pelanggan', 'Jumlah': getTotalReceivables() },
                    { 'Jenis': 'Hutang Supplier', 'Jumlah': getTotalPayables() }
                ];
                const financeWorksheet = XLSX.utils.json_to_sheet(financeData);
                XLSX.utils.book_append_sheet(workbook, financeWorksheet, 'Keuangan');
                
                // Save the workbook
                const today = new Date().toISOString().split('T')[0];
                XLSX.writeFile(workbook, `laporan-toko-${today}.xlsx`);
                
                showNotification('Data berhasil diexport ke Excel');
            } catch (error) {
                showNotification('Error saat export ke Excel: ' + error.message, true);
            }
        }

        // Export/Import functionality JSON
        function exportData() {
            // Hanya owner yang bisa export JSON
            if (!currentUser || currentUser.role !== 'owner') {
                showNotification('Hanya owner yang dapat melakukan export data lengkap!', true);
                return;
            }
            
            const data = {
                purchaseOrders,
                inventory,
                salesTransactions,
                incomeRecords,
                expenseRecords,
                utilityRecords,
                suppliers,
                users,
                exportDate: new Date()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `toko-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Data berhasil diexport ke JSON');
        }

        function importData(event) {
            // Hanya owner yang bisa import JSON
            if (!currentUser || currentUser.role !== 'owner') {
                showNotification('Hanya owner yang dapat melakukan import data!', true);
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (data.purchaseOrders && data.inventory && data.salesTransactions) {
                        // Replace data arrays with new data
                        purchaseOrders.splice(0, purchaseOrders.length, ...data.purchaseOrders);
                        inventory.splice(0, inventory.length, ...data.inventory);
                        salesTransactions.splice(0, salesTransactions.length, ...data.salesTransactions);
                        
                        if (data.incomeRecords) incomeRecords.splice(0, incomeRecords.length, ...data.incomeRecords);
                        if (data.expenseRecords) expenseRecords.splice(0, expenseRecords.length, ...data.expenseRecords);
                        if (data.utilityRecords) utilityRecords.splice(0, utilityRecords.length, ...data.utilityRecords);
                        if (data.suppliers) suppliers.splice(0, suppliers.length, ...data.suppliers);
                        if (data.users) users.splice(0, users.length, ...data.users);
                        
                        showNotification('Data berhasil diimpor');
                    } else {
                        showNotification('Format file tidak valid', true);
                    }
                } catch (error) {
                    showNotification('Error membaca file: ' + error.message, true);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Auto-save functionality
        function autoSave() {
            const data = {
                purchaseOrders,
                inventory,
                salesTransactions,
                incomeRecords,
                expenseRecords,
                utilityRecords,
                suppliers,
                users,
                lastSave: new Date()
            };
            
            localStorage.setItem('tokoAppData', JSON.stringify(data));
        }

        function loadAutoSave() {
            const savedData = localStorage.getItem('tokoAppData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // Only load if data is recent (within 7 days)
                    const saveDate = new Date(data.lastSave);
                    const daysDiff = (new Date() - saveDate) / (1000 * 60 * 60 * 24);
                    
                    if (daysDiff < 7) {
                        // Replace data arrays with saved data
                        if (data.purchaseOrders) purchaseOrders.splice(0, purchaseOrders.length, ...data.purchaseOrders);
                        if (data.inventory) inventory.splice(0, inventory.length, ...data.inventory);
                        if (data.salesTransactions) salesTransactions.splice(0, salesTransactions.length, ...data.salesTransactions);
                        if (data.incomeRecords) incomeRecords.splice(0, incomeRecords.length, ...data.incomeRecords);
                        if (data.expenseRecords) expenseRecords.splice(0, expenseRecords.length, ...data.expenseRecords);
                        if (data.utilityRecords) utilityRecords.splice(0, utilityRecords.length, ...data.utilityRecords);
                        if (data.suppliers) suppliers.splice(0, suppliers.length, ...data.suppliers);
                        if (data.users) users.splice(0, users.length, ...data.users);
                        
                        showNotification('Data sebelumnya berhasil dimuat');
                    }
                } catch (error) {
                    console.log('Tidak ada data tersimpan atau data korup');
                }
            }
        }

        // Set up auto-save interval
        setInterval(autoSave, 30000);

        // Responsive design
        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (window.innerWidth < 768) {
                sidebar.classList.add('hidden');
                mainContent.classList.add('expanded');
            } else {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('expanded');
            }
        }

        window.addEventListener('resize', handleResize);

        // Dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            showNotification('Mode ' + (document.body.classList.contains('dark-mode') ? 'gelap' : 'terang') + ' diaktifkan');
        }

        // Load dark mode preference
        function loadDarkModePreference() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
        }

        // Refresh active tab
        function refreshActiveTab(tabId) {
            switch(tabId) {
                case 'purchase':
                    updatePoTable();
                    updateSupplierTable();
                    break;
                case 'inventory':
                    updateStockTable();
                    updatePoSelect();
                    break;
                case 'sales':
                    updateSalesTable();
                    updateTransactionDetails();
                    break;
                case 'finance':
                    updateFinanceChart();
                    break;
                case 'profit':
                    calculateProfit();
                    updateProfitChart();
                    break;
                case 'users':
                    updateUsersTable();
                    break;
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S for save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                autoSave();
                showNotification('Data disimpan');
            }
            
            // Escape to clear transaction
            if (e.key === 'Escape') {
                if (currentTransactionItems.length > 0) {
                    clearTransaction();
                }
            }
        });

        // ================= FUNGSI BANTUAN =================
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        // Format date
        function formatDate(date) {
            return new Date(date).toLocaleDateString('id-ID');
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            if (!notification || !notificationText) return;
            
            notificationText.textContent = message;
            notification.className = 'notification';
            
            if (isError) {
                notification.classList.add('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar.classList.contains('hidden')) {
                sidebar.classList.remove('hidden');
                mainContent.classList.add('with-sidebar');
            } else {
                sidebar.classList.add('hidden');
                mainContent.classList.remove('with-sidebar');
            }
        }
        
        // Show tab
        function showTab(tabId) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all sidebar items
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
                
                // Add active class to corresponding sidebar item
                const correspondingSidebarItem = document.querySelector(`.sidebar-item[onclick="showTab('${tabId}')"]`);
                if (correspondingSidebarItem) {
                    correspondingSidebarItem.classList.add('active');
                }
                
                // Refresh tab content
                refreshActiveTab(tabId);
            }
        }
        
        // Load minimal sample data
        function loadMinimalSampleData() {
            // Sample inventory
            if (inventory.length === 0) {
                inventory = [
                    {
                        id: 1,
                        name: "Beras Premium",
                        stock: 50,
                        buyPrice: 12000,
                        sellPrice: 15000
                    },
                    {
                        id: 2,
                        name: "Minyak Goreng",
                        stock: 30,
                        buyPrice: 18000,
                        sellPrice: 22000
                    },
                    {
                        id: 3,
                        name: "Gula Pasir",
                        stock: 40,
                        buyPrice: 12000,
                        sellPrice: 15000
                    }
                ];
            }
            
            // Sample suppliers
            if (suppliers.length === 0) {
                suppliers = [
                    "PT. Distributor ABC",
                    "CV. Maju Sejahtera",
                    "UD. Makmur Jaya"
                ];
            }
            
            // Sample users
            if (users.length === 0) {
                users = [
                    {
                        id: 1,
                        fullName: "Admin Owner",
                        email: "bookingeast0@gmail.com",
                        role: "owner",
                        status: "active"
                    }
                ];
            }
        }
        
        // Setup form listeners
        function setupFormListeners() {
            // Purchase plan form
            const purchasePlanForm = document.getElementById('purchasePlanForm');
            if (purchasePlanForm) {
                purchasePlanForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addPurchaseOrder();
                });
            }
            
            // Sale form
            const saleForm = document.getElementById('saleForm');
            if (saleForm) {
                saleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addToTransaction();
                });
            }
            
            // User form
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addUser();
                });
            }
        }
        
        // Add purchase order
        function addPurchaseOrder() {
            const productName = document.getElementById('productName').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            let supplier = document.getElementById('supplierSelect').value;
            
            // Check if using manual input
            if (supplier === 'other') {
                supplier = document.getElementById('supplierInput').value;
            }
            
            if (!productName || !quantity || !unitPrice || !supplier) {
                showNotification('Harap isi semua field!', true);
                return;
            }
            
            // Add to suppliers if not exists
            if (!suppliers.includes(supplier)) {
                suppliers.push(supplier);
                updateSupplierSelect();
            }
            
            const poNumber = 'PO-' + Date.now();
            const total = quantity * unitPrice;
            
            const purchaseOrder = {
                id: Date.now(),
                poNumber: poNumber,
                date: new Date(),
                product: productName,
                supplier: supplier,
                quantity: quantity,
                price: unitPrice,
                total: total,
                status: 'pending'
            };
            
            purchaseOrders.push(purchaseOrder);
            
            // Reset form
            document.getElementById('purchasePlanForm').reset();
            document.getElementById('productInfo').classList.add('hidden');
            
            showNotification('Purchase Order berhasil ditambahkan');
            
            // Update tables
            updatePoTable();
            updateSupplierTable();
        }
        
        // Add to transaction
        function addToTransaction() {
            const productSelect = document.getElementById('soldProduct');
            const productName = productSelect.value;
            const quantity = parseInt(document.getElementById('soldQuantity').value);
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            
            if (!productName || !quantity) {
                showNotification('Harap pilih produk dan isi kuantitas!', true);
                return;
            }
            
            // Find product in inventory
            const product = inventory.find(p => p.name === productName);
            if (!product) {
                showNotification('Produk tidak ditemukan!', true);
                return;
            }
            
            // Check stock
            if (product.stock < quantity) {
                showNotification(`Stok ${product.name} tidak mencukupi! Stok tersedia: ${product.stock}`, true);
                return;
            }
            
            // Calculate price with discount
            const unitPrice = product.sellPrice;
            const discountAmount = (unitPrice * quantity * discount) / 100;
            const total = (unitPrice * quantity) - discountAmount;
            
            // Add to current transaction
            currentTransactionItems.push({
                product: productName,
                quantity: quantity,
                unitPrice: unitPrice,
                discount: discount,
                discountAmount: discountAmount,
                total: total
            });
            
            // Reduce stock
            product.stock -= quantity;
            
            // Reset form
            document.getElementById('soldQuantity').value = '';
            document.getElementById('discount').value = '0';
            
            showNotification(`${quantity} ${productName} ditambahkan ke transaksi`);
            
            // Update transaction details
            updateTransactionDetails();
        }
        
        // Add user
        async function addUser() {
            // Only owner can add users
            if (!currentUser || currentUser.role !== 'owner') {
                showNotification('Hanya owner yang dapat menambah user!', true);
                return;
            }
            
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const role = document.getElementById('userRoleSelect').value;
            
            if (!fullName || !email || !password || !confirmPassword) {
                showNotification('Harap isi semua field!', true);
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Password dan konfirmasi password tidak cocok!', true);
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password harus minimal 6 karakter!', true);
                return;
            }
            
            const userData = {
                fullName: fullName,
                email: email,
                role: role,
                status: 'active'
            };
            
            const user = await registerWithEmail(email, password, userData);
            
            if (user) {
                // Add to local users array
                users.push({
                    id: Date.now(),
                    ...userData
                });
                
                // Reset form
                document.getElementById('userForm').reset();
                
                showNotification('User berhasil ditambahkan');
                
                // Update users table
                updateUsersTable();
            }
        }
        
        // Update all stats
        function updateAllStats() {
            // Purchase stats
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const totalPurchaseMonth = purchaseOrders
                .filter(po => {
                    const poDate = new Date(po.date);
                    return poDate.getMonth() === currentMonth && poDate.getFullYear() === currentYear;
                })
                .reduce((sum, po) => sum + po.total, 0);
            
            document.getElementById('totalPurchaseMonth').textContent = formatCurrency(totalPurchaseMonth);
            document.getElementById('totalPOItems').textContent = purchaseOrders.filter(po => po.status === 'pending').length;
            document.getElementById('activeSuppliers').textContent = suppliers.length;
            
            // Inventory stats
            document.getElementById('totalInventoryItems').textContent = inventory.length;
            document.getElementById('lowStockItems').textContent = inventory.filter(item => item.stock <= 10).length;
            const totalInventoryValue = inventory.reduce((sum, item) => sum + (item.stock * item.buyPrice), 0);
            document.getElementById('totalInventoryValue').textContent = formatCurrency(totalInventoryValue);
            
            // Sales stats
            const today = new Date().toDateString();
            const todayTransactions = salesTransactions.filter(sale => new Date(sale.date).toDateString() === today);
            document.getElementById('todayTransactions').textContent = todayTransactions.length;
            const todaySales = todayTransactions.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById('todaySales').textContent = formatCurrency(todaySales);
            document.getElementById('activeCustomers').textContent = '0'; // Placeholder
            
            // Finance stats
            const totalIncome = incomeRecords.reduce((sum, inc) => sum + inc.amount, 0);
            const totalExpense = expenseRecords.reduce((sum, exp) => sum + exp.amount, 0);
            const totalUtility = utilityRecords.reduce((sum, util) => sum + util.amount, 0);
            const cashBalance = totalIncome - totalExpense - totalUtility;
            document.getElementById('cashBalance').textContent = formatCurrency(cashBalance);
            document.getElementById('customerReceivables').textContent = formatCurrency(0); // Placeholder
            document.getElementById('supplierPayables').textContent = formatCurrency(0); // Placeholder
            
            // Profit stats
            document.getElementById('totalRevenue').textContent = formatCurrency(getTotalRevenue());
            document.getElementById('totalCost').textContent = formatCurrency(getTotalCost());
            document.getElementById('netProfit').textContent = formatCurrency(getTotalRevenue() - getTotalCost());
            
            // Users stats
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeUsers').textContent = users.filter(u => u.status === 'active').length;
            document.getElementById('adminUsers').textContent = users.filter(u => u.role === 'owner').length;
        }
        
        // Update transaction details
        function updateTransactionDetails() {
            const transactionDetails = document.getElementById('transactionDetails');
            const subtotalElement = document.getElementById('subtotal');
            const discountAmountElement = document.getElementById('discountAmount');
            const totalAmountElement = document.getElementById('totalAmount');
            
            if (!transactionDetails) return;
            
            let html = '';
            let subtotal = 0;
            let totalDiscount = 0;
            
            currentTransactionItems.forEach((item, index) => {
                subtotal += item.unitPrice * item.quantity;
                totalDiscount += item.discountAmount;
                
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <div>
                            <strong>${item.product}</strong><br>
                            <small>${item.quantity} x ${formatCurrency(item.unitPrice)}</small>
                            ${item.discount > 0 ? `<br><small>Diskon: ${item.discount}%</small>` : ''}
                        </div>
                        <div>
                            ${formatCurrency(item.total)}
                            <button class="btn btn-small btn-danger" onclick="removeFromTransaction(${index})" style="margin-left: 10px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            if (currentTransactionItems.length === 0) {
                html = '<p style="text-align: center; color: #999;">Belum ada item dalam transaksi</p>';
            }
            
            transactionDetails.innerHTML = html;
            subtotalElement.textContent = formatCurrency(subtotal);
            discountAmountElement.textContent = formatCurrency(totalDiscount);
            totalAmountElement.textContent = formatCurrency(subtotal - totalDiscount);
        }
        
        // Remove from transaction
        function removeFromTransaction(index) {
            if (index >= 0 && index < currentTransactionItems.length) {
                const item = currentTransactionItems[index];
                
                // Restore stock
                const product = inventory.find(p => p.name === item.product);
                if (product) {
                    product.stock += item.quantity;
                }
                
                currentTransactionItems.splice(index, 1);
                updateTransactionDetails();
                showNotification('Item dihapus dari transaksi');
            }
        }
        
        // Update tables
        function updatePoTable() {
            const poTable = document.getElementById('poTable');
            if (!poTable) return;
            
            const tbody = poTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            purchaseOrders.forEach(po => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${po.poNumber}</td>
                    <td>${formatDate(po.date)}</td>
                    <td>${po.product}</td>
                    <td>${po.supplier}</td>
                    <td>${po.quantity}</td>
                    <td>${formatCurrency(po.price)}</td>
                    <td>${formatCurrency(po.total)}</td>
                    <td><span class="status-badge ${po.status === 'pending' ? 'status-pending' : 'status-completed'}">${po.status === 'pending' ? 'Menunggu' : 'Selesai'}</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateSupplierTable() {
            const supplierTable = document.getElementById('supplierTable');
            if (!supplierTable) return;
            
            const tbody = supplierTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            suppliers.forEach(supplier => {
                const supplierPOs = purchaseOrders.filter(po => po.supplier === supplier);
                const totalPOs = supplierPOs.length;
                const totalValue = supplierPOs.reduce((sum, po) => sum + po.total, 0);
                const activePOs = supplierPOs.filter(po => po.status === 'pending').length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier}</td>
                    <td>${totalPOs}</td>
                    <td>${formatCurrency(totalValue)}</td>
                    <td><span class="status-badge ${activePOs > 0 ? 'status-pending' : 'status-completed'}">${activePOs > 0 ? 'Aktif' : 'Tidak Aktif'}</span></td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="deleteSupplier('${supplier}')">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateStockTable() {
            const stockTable = document.getElementById('stockTable');
            if (!stockTable) return;
            
            const tbody = stockTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            // Update product select for sales
            const soldProductSelect = document.getElementById('soldProduct');
            if (soldProductSelect) {
                soldProductSelect.innerHTML = '<option value="">Pilih Produk</option>';
                inventory.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.textContent = `${product.name} (Stok: ${product.stock})`;
                    soldProductSelect.appendChild(option);
                });
            }
            
            inventory.forEach(product => {
                let status, statusClass;
                if (product.stock === 0) {
                    status = 'Kosong';
                    statusClass = 'status-out';
                } else if (product.stock <= 10) {
                    status = 'Stok Rendah';
                    statusClass = 'status-low';
                } else {
                    status = 'Tersedia';
                    statusClass = 'status-available';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.stock}</td>
                    <td>${formatCurrency(product.buyPrice)}</td>
                    <td>${formatCurrency(product.sellPrice)}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="btn btn-small btn-secondary" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateSalesTable() {
            const salesTable = document.getElementById('salesTable');
            if (!salesTable) return;
            
            const tbody = salesTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            salesTransactions.forEach(sale => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.items.map(item => item.product).join(', ')}</td>
                    <td>${sale.items.reduce((sum, item) => sum + item.quantity, 0)}</td>
                    <td>${formatCurrency(sale.total)}</td>
                    <td><span class="status-badge status-completed">Selesai</span></td>
                    ${currentUser && currentUser.role !== 'kasir' ? `
                    <td>
                        <button class="btn btn-small btn-danger" onclick="deleteSale('${sale.id}')">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </td>
                    ` : ''}
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateUsersTable() {
            const usersTable = document.getElementById('usersTable');
            if (!usersTable) return;
            
            const tbody = usersTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.fullName}</td>
                    <td>${user.email}</td>
                    <td><span class="user-role-badge role-${user.role}">${user.role}</span></td>
                    <td><span class="status-badge ${user.status === 'active' ? 'status-available' : 'status-out'}">${user.status === 'active' ? 'Aktif' : 'Nonaktif'}</span></td>
                    <td>
                        <button class="btn btn-small btn-secondary" onclick="editUser(${user.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Delete sale
        async function deleteSale(id) {
            if (!currentUser || currentUser.role === 'kasir') {
                showNotification('Anda tidak memiliki izin untuk menghapus transaksi!', true);
                return;
            }
            
            const confirmDelete = confirm('Apakah Anda yakin ingin menghapus transaksi ini?');
            if (!confirmDelete) return;
            
            // Delete from Firebase
            const success = await deleteSalesFromFirebase(id);
            
            if (success) {
                // Delete from local array
                const index = salesTransactions.findIndex(sale => sale.id === id);
                if (index !== -1) {
                    salesTransactions.splice(index, 1);
                    showNotification('Transaksi berhasil dihapus');
                    updateSalesTable();
                }
            }
        }
        
        // Reset all data
        function resetAllData() {
            if (!currentUser || currentUser.role !== 'owner') {
                showNotification('Hanya owner yang dapat mereset data!', true);
                return;
            }
            
            const confirmReset = confirm('Apakah Anda yakin ingin mereset semua data? Tindakan ini tidak dapat dibatalkan!');
            if (!confirmReset) return;
            
            purchaseOrders = [];
            inventory = [];
            salesTransactions = [];
            incomeRecords = [];
            expenseRecords = [];
            utilityRecords = [];
            suppliers = [];
            
            // Keep only the current user
            users = users.filter(user => user.email === currentUser.email);
            
            // Clear localStorage
            localStorage.removeItem('tokoAppData');
            
            showNotification('Semua data berhasil direset');
            
            // Update all tables and stats
            updatePoTable();
            updateSupplierTable();
            updateStockTable();
            updateSalesTable();
            updateUsersTable();
            updateAllStats();
        }
        
        // Helper functions for finance calculations
        function getTotalReceivables() {
            // Placeholder - implement based on your business logic
            return 0;
        }
        
        function getTotalPayables() {
            // Placeholder - implement based on your business logic
            return 0;
        }
        
        // Initialize the app
        window.onload = function() {
            // Set default tab
            showTab('sales');
        };
    </script>
</body>
</html>
