<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pertokoan</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS tetap sama seperti sebelumnya */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            min-height: 100vh;
        }
        
        /* ... (CSS lainnya tetap sama) ... */
        
    </style>
</head>
<body>
    <!-- HTML struktur tetap sama seperti sebelumnya -->
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <!-- Ikon animasi perdagangan di latar belakang -->
        <div class="trade-icon" style="top: 20%; left: 15%;"><i class="fas fa-shopping-cart"></i></div>
        <div class="trade-icon" style="top: 40%; left: 80%;"><i class="fas fa-boxes"></i></div>
        <div class="trade-icon" style="top: 60%; left: 25%;"><i class="fas fa-cash-register"></i></div>
        <div class="trade-icon" style="top: 75%; left: 70%;"><i class="fas fa-chart-line"></i></div>
        <div class="trade-icon" style="top: 10%; left: 60%;"><i class="fas fa-tag"></i></div>
        <div class="trade-icon" style="top: 85%; left: 10%;"><i class="fas fa-truck"></i></div>
        <div class="trade-icon" style="top: 30%; left: 45%;"><i class="fas fa-dollar-sign"></i></div>
        <div class="trade-icon" style="top: 55%; left: 90%;"><i class="fas fa-receipt"></i></div>
    
        <!-- Teks Grafiti -->
        <div class="graffiti-text">
            <div>Powered by</div>
            <span>Oem821</span>
        </div>
    
        <div class="login-card">
            <h2><i class="fas fa-store"></i> Login Aplikasi Pertokoan</h2>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="username" placeholder="Masukkan username">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="password" placeholder="Masukkan password">
            </div>
            <button id="loginBtn" class="btn login-btn">Login</button>
        </div>
    </div>

    <!-- Sidebar Menu -->
    <div id="sidebar" class="sidebar hidden">
        <!-- ... (sidebar content tetap sama) ... -->
    </div>

    <!-- Main Application -->
    <div id="app" class="main-content" style="display: none;">
        <div class="container">
            <header>
                <!-- ... (header content tetap sama) ... -->
            </header>

            <!-- Tab Pembelian -->
            <div id="purchase" class="tab-content">
                <!-- ... (purchase content tetap sama) ... -->
            </div>

            <!-- Tab Persediaan -->
            <div id="inventory" class="tab-content">
                <h2><i class="fas fa-boxes"></i> Manajemen Persediaan</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalInventoryItems">0</div>
                        <div class="stat-label">Total Item Persediaan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lowStockItems">0</div>
                        <div class="stat-label">Item Low Stock</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalInventoryValue">Rp 0</div>
                        <div class="stat-label">Nilai Total Persediaan</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Penerimaan Barang</h3>
                    <form id="receivingForm">
                        <div class="form-group">
                            <label>Nomor PO:</label>
                            <select id="poNumber" onchange="fillReceivingForm()">
                                <option value="">Pilih Nomor PO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nama Produk:</label>
                            <input type="text" id="receivedProduct" placeholder="Nama produk yang diterima" readonly>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Kuantitas PO:</label>
                                <input type="number" id="poQuantity" placeholder="Jumlah yang dipesan" readonly>
                            </div>
                            <div class="form-group">
                                <label>Kuantitas Diterima:</label>
                                <input type="number" id="receivedQuantity" placeholder="Jumlah yang diterima" min="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Harga Beli dari PO:</label>
                                <input type="number" id="poBuyPrice" placeholder="Harga beli dari PO" readonly>
                            </div>
                            <div class="form-group">
                                <label>Harga Jual Baru:</label>
                                <input type="number" id="newSellPriceReceiving" placeholder="Harga jual baru" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Kualitas:</label>
                            <select id="quality">
                                <option value="good">Baik</option>
                                <option value="damaged">Rusak</option>
                                <option value="expired">Kadaluwarsa</option>
                            </select>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-check-circle"></i> Konfirmasi Penerimaan</button>
                    </form>
                </div>
                
                <div class="card">
                    <h3>Stok Produk</h3>
                    <input type="text" class="search-box" placeholder="Cari produk..." oninput="searchTable('stockTable', this.value)">
                    <div class="table-container">
                        <table id="stockTable">
                            <thead>
                                <tr>
                                    <th>Produk</th>
                                    <th>Stok</th>
                                    <th>Harga Beli</th>
                                    <th>Harga Jual</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab Penjualan -->
            <div id="sales" class="tab-content active">
                <!-- ... (sales content tetap sama) ... -->
            </div>

            <!-- Tab Keuangan -->
            <div id="finance" class="tab-content">
                <h2><i class="fas fa-chart-line"></i> Keuangan</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="cashBalance">Rp 0</div>
                        <div class="stat-label">Saldo Kas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="customerReceivables">Rp 0</div>
                        <div class="stat-label">Piutang Pelanggan</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="supplierPayables">Rp 0</div>
                        <div class="stat-label">Hutang Supplier</div>
                    </div>
                </div>
                
                <!-- ... (finance content lainnya tetap sama) ... -->
            </div>

            <!-- Tab Laba/Rugi -->
            <div id="profit" class="tab-content">
                <!-- ... (profit content tetap sama) ... -->
            </div>

            <!-- Tab Manajemen User -->
            <div id="users" class="tab-content">
                <!-- ... (users content tetap sama) ... -->
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // Data storage
        let purchaseOrders = [];
        let inventory = [];
        let salesTransactions = [];
        let incomeRecords = [];
        let expenseRecords = [];
        let utilityRecords = [];
        let suppliers = [];
        let users = [];
        
        // Current transaction items
        let currentTransactionItems = [];
        
        // Current user
        let currentUser = null;

        // Auto-refresh system
        let autoRefreshInterval;

        // Data Observer untuk update realtime
        const dataObservers = {
            purchaseOrders: [],
            inventory: [],
            salesTransactions: [],
            incomeRecords: [],
            expenseRecords: [],
            utilityRecords: [],
            suppliers: [],
            users: []
        };

        // Fungsi untuk mendaftarkan observer
        function registerObserver(dataType, callback) {
            if (dataObservers[dataType]) {
                dataObservers[dataType].push(callback);
            }
        }

        // Fungsi untuk memicu update observer
        function notifyObservers(dataType) {
            if (dataObservers[dataType]) {
                dataObservers[dataType].forEach(callback => {
                    try {
                        callback();
                    } catch (error) {
                        console.error('Error in observer callback:', error);
                    }
                });
            }
        }

        // Membuat reactive arrays dengan Proxy
        function createReactiveArray(array, dataType) {
            return new Proxy(array, {
                set: function(target, property, value, receiver) {
                    const result = Reflect.set(target, property, value, receiver);
                    if (!isNaN(property) || property === 'length') {
                        notifyObservers(dataType);
                        triggerDataUpdate();
                    }
                    return result;
                },
                deleteProperty: function(target, property) {
                    const result = Reflect.deleteProperty(target, property);
                    if (!isNaN(property)) {
                        notifyObservers(dataType);
                        triggerDataUpdate();
                    }
                    return result;
                }
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set up login
            document.getElementById('loginBtn').addEventListener('click', login);
            
            // Membuat data arrays menjadi reactive
            purchaseOrders = createReactiveArray([], 'purchaseOrders');
            inventory = createReactiveArray([], 'inventory');
            salesTransactions = createReactiveArray([], 'salesTransactions');
            incomeRecords = createReactiveArray([], 'incomeRecords');
            expenseRecords = createReactiveArray([], 'expenseRecords');
            utilityRecords = createReactiveArray([], 'utilityRecords');
            suppliers = createReactiveArray([], 'suppliers');
            users = createReactiveArray([], 'users');
            
            // Mendaftarkan observer untuk update otomatis
            registerObserver('purchaseOrders', updatePurchaseStats);
            registerObserver('inventory', updateInventoryStats);
            registerObserver('salesTransactions', updateSalesStats);
            registerObserver('incomeRecords', updateFinanceStats);
            registerObserver('expenseRecords', updateFinanceStats);
            registerObserver('utilityRecords', updateFinanceStats);
            registerObserver('suppliers', updatePurchaseStats);
            registerObserver('users', updateUserStats);
            
            // Load sample data for demonstration
            loadSampleData();
            
            // Setup form event listeners
            setupFormListeners();
            
            // Setup real-time data monitoring
            setupRealtimeListeners();
            
            // Load saved data
            loadAutoSave();
            
            // Handle responsive design
            handleResize();
            
            // Load dark mode preference
            loadDarkModePreference();
        });

        // Setup form event listeners
        function setupFormListeners() {
            // Income form
            document.getElementById('incomeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const source = document.getElementById('incomeSource').value;
                const amount = parseFloat(document.getElementById('incomeAmount').value);
                const description = document.getElementById('incomeDescription').value;
                
                if (!amount) {
                    showNotification('Harap masukkan jumlah pemasukan!', true);
                    return;
                }
                
                incomeRecords.push({
                    id: Date.now(),
                    date: new Date(),
                    source: source,
                    amount: amount,
                    description: description
                });
                
                // Reset form
                this.reset();
                showNotification('Pemasukan berhasil dicatat');
            });

            // Expense form
            document.getElementById('expenseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const type = document.getElementById('expenseType').value;
                const amount = parseFloat(document.getElementById('expenseAmount').value);
                const description = document.getElementById('expenseDescription').value;
                
                if (!amount) {
                    showNotification('Harap masukkan jumlah pengeluaran!', true);
                    return;
                }
                
                expenseRecords.push({
                    id: Date.now(),
                    date: new Date(),
                    type: type,
                    amount: amount,
                    description: description
                });
                
                // Reset form
                this.reset();
                showNotification('Pengeluaran berhasil dicatat');
            });

            // Utility form
            document.getElementById('utilityForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const type = document.getElementById('utilityType').value;
                const period = document.getElementById('utilityPeriod').value;
                const amount = parseFloat(document.getElementById('utilityAmount').value);
                const description = document.getElementById('utilityDescription').value;
                
                if (!amount || !period) {
                    showNotification('Harap masukkan jumlah dan periode biaya utilitas!', true);
                    return;
                }
                
                utilityRecords.push({
                    id: Date.now(),
                    date: new Date(),
                    type: type,
                    period: period,
                    amount: amount,
                    description: description
                });
                
                // Reset form
                this.reset();
                showNotification('Biaya utilitas berhasil dicatat');
            });

            // Purchase Plan Form
            document.getElementById('purchasePlanForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const productName = document.getElementById('productName').value;
                const quantity = parseInt(document.getElementById('quantity').value);
                const unitPrice = parseFloat(document.getElementById('unitPrice').value);
                
                // Get supplier from either select or input
                let supplier = '';
                const supplierSelect = document.getElementById('supplierSelect');
                const supplierInput = document.getElementById('supplierInput');
                
                if (supplierSelect.value === 'other' || supplierInput.style.display !== 'none') {
                    supplier = supplierInput.value.trim();
                    if (!supplier) {
                        showNotification('Harap masukkan nama supplier!', true);
                        return;
                    }
                    
                    // Add new supplier to list if not exists
                    if (!suppliers.includes(supplier)) {
                        suppliers.push(supplier);
                        updateSupplierSelect();
                    }
                } else {
                    supplier = supplierSelect.value;
                }
                
                if (!productName || !quantity || !unitPrice || !supplier) {
                    showNotification('Harap isi semua field!', true);
                    return;
                }
                
                const total = quantity * unitPrice;
                const poNumber = 'PO-' + (purchaseOrders.length + 1).toString().padStart(3, '0');
                
                const po = {
                    id: Date.now(),
                    poNumber: poNumber,
                    date: new Date(),
                    product: productName,
                    supplier: supplier,
                    quantity: quantity,
                    price: unitPrice,
                    total: total,
                    status: 'pending'
                };
                
                purchaseOrders.push(po);
                
                // Reset form
                this.reset();
                document.getElementById('productInfo').classList.add('hidden');
                showNotification(`PO ${poNumber} untuk ${productName} berhasil ditambahkan`);
            });

            // PERBAIKAN: Receiving Goods Form - Fix untuk PO outstanding
            document.getElementById('receivingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const poNumber = document.getElementById('poNumber').value;
                const receivedProduct = document.getElementById('receivedProduct').value;
                const receivedQuantity = parseInt(document.getElementById('receivedQuantity').value);
                const quality = document.getElementById('quality').value;
                const newSellPrice = parseFloat(document.getElementById('newSellPriceReceiving').value);
                
                if (!poNumber || !receivedProduct || !receivedQuantity) {
                    showNotification('Harap isi semua field!', true);
                    return;
                }
                
                // Find the PO to get the purchase price
                const po = purchaseOrders.find(p => p.poNumber === poNumber);
                if (!po) {
                    showNotification('PO tidak ditemukan!', true);
                    return;
                }
                
                const buyPrice = po.price;
                
                // Find product in inventory
                const productIndex = inventory.findIndex(item => item.name.toLowerCase() === receivedProduct.toLowerCase());
                
                if (productIndex !== -1) {
                    // Calculate weighted average price if product already exists
                    const existingProduct = inventory[productIndex];
                    const totalCost = (existingProduct.stock * existingProduct.buyPrice) + (receivedQuantity * buyPrice);
                    const totalStock = existingProduct.stock + receivedQuantity;
                    const averageBuyPrice = totalCost / totalStock;
                    
                    inventory[productIndex].stock = totalStock;
                    inventory[productIndex].buyPrice = averageBuyPrice;
                    
                    // Update sell price if provided
                    if (newSellPrice && newSellPrice > 0) {
                        inventory[productIndex].sellPrice = newSellPrice;
                    }
                } else {
                    // Create new product
                    inventory.push({
                        id: Date.now(),
                        name: receivedProduct,
                        stock: receivedQuantity,
                        buyPrice: buyPrice,
                        sellPrice: newSellPrice || (buyPrice * 1.3)
                    });
                }
                
                // PERBAIKAN: Update PO status dan catat sebagai pengeluaran
                po.status = 'completed';
                
                // Catat sebagai pengeluaran pembelian
                expenseRecords.push({
                    id: Date.now(),
                    date: new Date(),
                    type: 'purchase',
                    amount: po.total,
                    description: `Pembelian ${receivedProduct} dari ${po.supplier} (${po.poNumber})`
                });
                
                // Reset form
                this.reset();
                updatePoSelect(); // Refresh dropdown PO
                showNotification(`${receivedQuantity} unit ${receivedProduct} berhasil diterima`);
            });

            // Sale Form
            document.getElementById('saleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const soldProduct = document.getElementById('soldProduct').value;
                const soldQuantity = parseInt(document.getElementById('soldQuantity').value);
                const discount = parseInt(document.getElementById('discount').value) || 0;
                
                if (!soldProduct || !soldQuantity) {
                    showNotification('Harap isi semua field!', true);
                    return;
                }
                
                const product = inventory.find(item => item.id == soldProduct);
                
                if (!product || product.stock < soldQuantity) {
                    showNotification('Stok tidak cukup atau produk tidak ditemukan!', true);
                    return;
                }
                
                const originalPrice = product.sellPrice;
                const discountedPrice = originalPrice * (1 - discount / 100);
                const total = discountedPrice * soldQuantity;
                
                // Add to current transaction
                currentTransactionItems.push({
                    product: product.name,
                    quantity: soldQuantity,
                    price: discountedPrice,
                    total: total
                });
                
                // Update stock
                product.stock -= soldQuantity;
                
                // Update related components
                updateTransactionDetails();
                
                // Reset form
                document.getElementById('soldQuantity').value = '';
                document.getElementById('discount').value = '0';
                showNotification(`${soldQuantity} unit ${product.name} berhasil ditambahkan ke transaksi`);
            });

            // Profit Calculation Form
            document.getElementById('profitForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                calculateProfit();
                showNotification('Perhitungan laba/rugi selesai');
            });

            // User Form
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const fullName = document.getElementById('fullName').value;
                const username = document.getElementById('newUsername').value;
                const password = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const role = document.getElementById('userRoleSelect').value;
                
                if (!fullName || !username || !password || !confirmPassword) {
                    showNotification('Harap isi semua field!', true);
                    return;
                }
                
                if (password !== confirmPassword) {
                    showNotification('Password dan konfirmasi password tidak cocok!', true);
                    return;
                }
                
                // Check if username already exists
                if (users.find(user => user.username === username)) {
                    showNotification('Username sudah digunakan!', true);
                    return;
                }
                
                // Add new user
                users.push({
                    id: Date.now(),
                    fullName: fullName,
                    username: username,
                    password: password,
                    role: role,
                    status: 'active'
                });
                
                // Reset form
                this.reset();
                showNotification(`User ${fullName} berhasil ditambahkan`);
            });
        }

        // Setup real-time data monitoring
        function setupRealtimeListeners() {
            // Tidak perlu lagi karena sudah menggunakan Proxy
        }

        function triggerDataUpdate() {
            // Auto-save data
            autoSave();
        }

        // Load sample data for demonstration
        function loadSampleData() {
            // Sample suppliers
            suppliers.push(
                'PT. Distributor ABC',
                'CV. Maju Sejahtera',
                'UD. Makmur Jaya'
            );
            
            // Sample products
            inventory.push(
                { id: 1, name: 'Sabun Mandi', stock: 50, buyPrice: 15000, sellPrice: 20000 },
                { id: 2, name: 'Shampoo', stock: 30, buyPrice: 25000, sellPrice: 35000 },
                { id: 3, name: 'Pasta Gigi', stock: 80, buyPrice: 8000, sellPrice: 12000 },
                { id: 4, name: 'Sabun Cuci Piring', stock: 20, buyPrice: 12000, sellPrice: 18000 }
            );
            
            // Sample purchase orders
            purchaseOrders.push(
                { id: 1001, poNumber: 'PO-001', date: new Date(), product: 'Sabun Mandi', supplier: 'PT. Distributor ABC', quantity: 50, price: 15000, total: 750000, status: 'pending' },
                { id: 1002, poNumber: 'PO-002', date: new Date(), product: 'Shampoo', supplier: 'CV. Maju Sejahtera', quantity: 30, price: 25000, total: 750000, status: 'pending' }
            );
            
            // Sample sales transactions
            salesTransactions.push(
                { id: 2001, date: new Date(), items: [{ product: 'Sabun Mandi', quantity: 2, price: 20000, total: 40000 }], total: 40000, status: 'completed' }
            );
            
            // PERBAIKAN: Sample income records - Reset ke 0 untuk menghindari saldo awal yang salah
            incomeRecords.push(
                { id: 3001, date: new Date(), source: 'sales', amount: 40000, description: 'Penjualan produk' }
            );
            
            // PERBAIKAN: Sample expense records - Reset ke 0 untuk menghindari saldo awal yang salah
            expenseRecords.push(
                { id: 4001, date: new Date(), type: 'operational', amount: 50000, description: 'Biaya operasional toko' }
            );
            
            // Sample utility records
            utilityRecords.push(
                { id: 5001, date: new Date(), type: 'electricity', period: '2023-10', amount: 450000, description: 'Tagihan listrik bulan Oktober' },
                { id: 5002, date: new Date(), type: 'water', period: '2023-10', amount: 120000, description: 'Tagihan air bulan Oktober' }
            );
            
            // Sample users
            users.push(
                { id: 1, fullName: 'Admin Owner', username: 'owner', password: 'owner123', role: 'owner', status: 'active' },
                { id: 2, fullName: 'Kasir Toko', username: 'kasir', password: 'kasir123', role: 'kasir', status: 'active' },
                { id: 3, fullName: 'Manager Toko', username: 'manager', password: 'manager123', role: 'manager', status: 'active' }
            );
        }

        // PERBAIKAN: Update Po Select - Hanya menampilkan PO yang masih pending
        function updatePoSelect() {
            const select = document.getElementById('poNumber');
            if (!select) return;
            
            select.innerHTML = '<option value="">Pilih Nomor PO</option>';
            
            // Hanya tampilkan PO dengan status 'pending'
            const pendingPOs = purchaseOrders.filter(po => po.status === 'pending');
            
            pendingPOs.forEach(po => {
                const option = document.createElement('option');
                option.value = po.poNumber;
                option.textContent = `${po.poNumber} - ${po.product} (${po.supplier})`;
                select.appendChild(option);
            });
            
            // Jika tidak ada PO pending, tampilkan pesan
            if (pendingPOs.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Tidak ada PO yang outstanding";
                option.disabled = true;
                select.appendChild(option);
            }
        }

        // PERBAIKAN: Fill Receiving Form - Pastikan hanya memproses PO yang valid
        function fillReceivingForm() {
            const poNumber = document.getElementById('poNumber').value;
            
            if (!poNumber) {
                clearReceivingForm();
                return;
            }
            
            const po = purchaseOrders.find(p => p.poNumber === poNumber && p.status === 'pending');
            
            if (po) {
                document.getElementById('receivedProduct').value = po.product;
                document.getElementById('poQuantity').value = po.quantity;
                document.getElementById('receivedQuantity').value = po.quantity;
                document.getElementById('poBuyPrice').value = po.price;
                
                // Calculate suggested sell price (30% markup)
                const suggestedSellPrice = po.price * 1.3;
                document.getElementById('newSellPriceReceiving').value = Math.round(suggestedSellPrice);
            } else {
                clearReceivingForm();
                showNotification('PO tidak ditemukan atau sudah diproses!', true);
            }
        }

        function clearReceivingForm() {
            document.getElementById('receivedProduct').value = '';
            document.getElementById('poQuantity').value = '';
            document.getElementById('receivedQuantity').value = '';
            document.getElementById('poBuyPrice').value = '';
            document.getElementById('newSellPriceReceiving').value = '';
        }

        // PERBAIKAN: Finance stats - Perhitungan saldo kas yang benar
        function updateFinanceStats() {
            const totalIncome = incomeRecords.reduce((sum, inc) => sum + inc.amount, 0);
            const totalExpense = expenseRecords.reduce((sum, exp) => sum + exp.amount, 0);
            const totalUtility = utilityRecords.reduce((sum, util) => sum + util.amount, 0);
            
            // PERBAIKAN: Hitung saldo kas yang benar (Pemasukan - Pengeluaran - Biaya Utilitas)
            const cashBalance = totalIncome - totalExpense - totalUtility;
            
            document.getElementById('cashBalance').textContent = formatCurrency(cashBalance);
            document.getElementById('customerReceivables').textContent = formatCurrency(getTotalReceivables());
            document.getElementById('supplierPayables').textContent = formatCurrency(getTotalPayables());
        }

        // PERBAIKAN: Delete Sales Transaction - Perbaikan perhitungan keuangan
        function deleteSalesTransaction(id) {
            const sale = salesTransactions.find(s => s.id === id);
            if (sale) {
                const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus transaksi penjualan ini?`);
                if (confirmDelete) {
                    // Restore stock for all items in the transaction
                    sale.items.forEach(item => {
                        const product = inventory.find(p => p.name === item.product);
                        if (product) {
                            product.stock += item.quantity;
                        }
                    });
                    
                    // Remove the transaction
                    const index = salesTransactions.findIndex(s => s.id === id);
                    if (index !== -1) {
                        salesTransactions.splice(index, 1);
                        
                        // PERBAIKAN: Hapus income record yang sesuai
                        const incomeIndex = incomeRecords.findIndex(inc => 
                            Math.abs(inc.amount - sale.total) < 0.01 && // Bandingkan dengan toleransi
                            inc.description.includes('Penjualan produk')
                        );
                        
                        if (incomeIndex !== -1) {
                            incomeRecords.splice(incomeIndex, 1);
                        }
                        
                        showNotification('Transaksi penjualan berhasil dihapus');
                    }
                }
            }
        }

        // PERBAIKAN: Complete Transaction - Pastikan income dicatat dengan benar
        function completeTransaction() {
            if (currentTransactionItems.length === 0) {
                showNotification('Belum ada item di transaksi!', true);
                return;
            }
            
            const totalAmount = currentTransactionItems.reduce((sum, item) => sum + item.total, 0);
            
            const sale = {
                id: Date.now(),
                date: new Date(),
                items: [...currentTransactionItems],
                total: totalAmount,
                status: 'completed'
            };
            
            salesTransactions.push(sale);
            
            // PERBAIKAN: Add to income records dengan deskripsi yang tepat
            incomeRecords.push({
                id: Date.now(),
                date: new Date(),
                source: 'sales',
                amount: totalAmount,
                description: 'Penjualan: ' + currentTransactionItems.map(item => 
                    `${item.quantity}x ${item.product}`
                ).join(', ')
            });
            
            // Clear current transaction
            currentTransactionItems = [];
            updateTransactionDetails();
            
            showNotification('Transaksi selesai!');
        }

        // Utility functions (tetap sama)
        function formatDate(date) {
            return new Date(date).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function getStatusText(statusClass) {
            switch(statusClass) {
                case 'status-available': return 'Tersedia';
                case 'status-low': return 'Stok Rendah';
                case 'status-out': return 'Kosong';
                default: return 'Tidak Diketahui';
            }
        }

        function populateProductSelect() {
            const select = document.getElementById('soldProduct');
            if (!select) return;
            
            select.innerHTML = '<option value="">Pilih Produk</option>';
            
            inventory.forEach(item => {
                if (item.stock > 0) {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} (Stok: ${item.stock}) - ${formatCurrency(item.sellPrice)}`;
                    select.appendChild(option);
                }
            });
        }

        function updateTransactionDetails() {
            const container = document.getElementById('transactionDetails');
            const subtotalEl = document.getElementById('subtotal');
            const discountEl = document.getElementById('discountAmount');
            const totalEl = document.getElementById('totalAmount');
            
            if (!container || !subtotalEl || !discountEl || !totalEl) return;
            
            if (currentTransactionItems.length === 0) {
                container.innerHTML = '<p>Tidak ada item dalam transaksi saat ini</p>';
                subtotalEl.textContent = 'Rp 0';
                discountEl.textContent = 'Rp 0';
                totalEl.textContent = 'Rp 0';
                return;
            }
            
            let detailsHtml = '<ul>';
            currentTransactionItems.forEach(item => {
                detailsHtml += `<li>${item.quantity} x ${item.product} @ ${formatCurrency(item.price)} = ${formatCurrency(item.total)}</li>`;
            });
            detailsHtml += '</ul>';
            
            container.innerHTML = detailsHtml;
            
            const subtotal = currentTransactionItems.reduce((sum, item) => sum + item.total, 0);
            const discount = Math.round(subtotal * (document.getElementById('discount').value || 0) / 100);
            const total = subtotal - discount;
            
            subtotalEl.textContent = formatCurrency(subtotal);
            discountEl.textContent = formatCurrency(discount);
            totalEl.textContent = formatCurrency(total);
        }

        // Business calculations (tetap sama)
        function getTotalRevenue() {
            return salesTransactions.reduce((sum, sale) => sum + sale.total, 0);
        }

        function getTotalCost() {
            return purchaseOrders.reduce((sum, po) => sum + po.total, 0) +
                   expenseRecords.filter(exp => exp.type !== 'purchase').reduce((sum, exp) => sum + exp.amount, 0) +
                   utilityRecords.reduce((sum, util) => sum + util.amount, 0);
        }

        function getCOGS() {
            return purchaseOrders.reduce((sum, po) => sum + po.total, 0);
        }

        function getSalaryCost() {
            return expenseRecords.filter(exp => exp.type === 'salary').reduce((sum, exp) => sum + exp.amount, 0);
        }

        function getUtilityCost() {
            return utilityRecords.reduce((sum, util) => sum + util.amount, 0);
        }

        function getTotalReceivables() {
            return salesTransactions.filter(sale => sale.status === 'pending').reduce((sum, sale) => sum + sale.total, 0);
        }

        function getTotalPayables() {
            return purchaseOrders.filter(po => po.status === 'pending').reduce((sum, po) => sum + po.total, 0);
        }

        // ... (fungsi lainnya tetap sama) ...

        // Login function dengan perbaikan inisialisasi
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification('Harap masukkan username dan password!', true);
                return;
            }
            
            // Find user
            const user = users.find(u => u.username === username && u.password === password);
            
            if (!user) {
                showNotification('Username atau password salah!', true);
                return;
            }
            
            if (user.status !== 'active') {
                showNotification('Akun tidak aktif!', true);
                return;
            }
            
            currentUser = user;
            document.getElementById('currentUser').textContent = user.fullName;
            
            // Hide login screen, show app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            // Show sidebar after login
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = 'block';
            sidebar.classList.remove('hidden');
            
            // Add margin to main content
            const mainContent = document.querySelector('.main-content');
            mainContent.classList.add('with-sidebar');
            
            // Show menu toggle button
            document.querySelector('.menu-toggle').style.display = 'block';
            
            // Set up UI based on user role
            setupUserInterface();
            
            // PERBAIKAN: Initialize data setelah login dengan memanggil updatePoSelect()
            updateAllStats();
            initializeCharts();
            updatePoSelect(); // Pastikan dropdown PO ter-update
            
            // Start auto-refresh
            startAutoRefresh();
            
            showNotification(`Login sebagai ${user.fullName} berhasil`);
        }

                // Business calculations
        function getTotalRevenue() {
            return salesTransactions.reduce((sum, sale) => sum + sale.total, 0);
        }

        function getTotalCost() {
            return purchaseOrders.reduce((sum, po) => sum + po.total, 0) +
                   expenseRecords.filter(exp => exp.type !== 'purchase').reduce((sum, exp) => sum + exp.amount, 0) +
                   utilityRecords.reduce((sum, util) => sum + util.amount, 0);
        }

        function getCOGS() {
            return purchaseOrders.reduce((sum, po) => sum + po.total, 0);
        }

        function getSalaryCost() {
            return expenseRecords.filter(exp => exp.type === 'salary').reduce((sum, exp) => sum + exp.amount, 0);
        }

        function getUtilityCost() {
            return utilityRecords.reduce((sum, util) => sum + util.amount, 0);
        }

        function getTotalReceivables() {
            return salesTransactions.filter(sale => sale.status === 'pending').reduce((sum, sale) => sum + sale.total, 0);
        }

        function getTotalPayables() {
            return purchaseOrders.filter(po => po.status === 'pending').reduce((sum, po) => sum + po.total, 0);
        }

        function calculateProfit() {
            const revenue = getTotalRevenue();
            const cogs = getCOGS();
            const operationalCost = expenseRecords.filter(exp => exp.type === 'operational').reduce((sum, exp) => sum + exp.amount, 0);
            const salaryCost = getSalaryCost();
            const utilityCost = getUtilityCost();
            const otherCost = expenseRecords.filter(exp => !['purchase', 'operational', 'salary', 'utility'].includes(exp.type)).reduce((sum, exp) => sum + exp.amount, 0);
            const totalCost = cogs + operationalCost + salaryCost + utilityCost + otherCost;
            const netProfit = revenue - totalCost;
            
            document.getElementById('profitTotalRevenue').textContent = formatCurrency(revenue);
            document.getElementById('profitCostOfGoodsSold').textContent = formatCurrency(cogs);
            document.getElementById('profitOperationalCost').textContent = formatCurrency(operationalCost);
            document.getElementById('profitSalaryCost').textContent = formatCurrency(salaryCost);
            document.getElementById('profitUtilityCost').textContent = formatCurrency(utilityCost);
            document.getElementById('profitOtherCost').textContent = formatCurrency(otherCost);
            document.getElementById('profitTotalCost').textContent = formatCurrency(totalCost);
            document.getElementById('profitNetProfit').textContent = formatCurrency(netProfit);
            
            // Calculate percentages
            const revenuePercent = revenue > 0 ? ((revenue - totalCost) / revenue * 100).toFixed(1) : 0;
            document.getElementById('revenuePercent').textContent = `${revenuePercent}%`;
            
            const cogsPercent = revenue > 0 ? (cogs / revenue * 100).toFixed(1) : 0;
            document.getElementById('cogsPercent').textContent = `${cogsPercent}%`;
            
            const opexPercent = revenue > 0 ? (operationalCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('opexPercent').textContent = `${opexPercent}%`;
            
            const salaryPercent = revenue > 0 ? (salaryCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('salaryPercent').textContent = `${salaryPercent}%`;
            
            const utilityPercent = revenue > 0 ? (utilityCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('utilityPercent').textContent = `${utilityPercent}%`;
            
            const otherPercent = revenue > 0 ? (otherCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('otherPercent').textContent = `${otherPercent}%`;
            
            const totalCostPercent = revenue > 0 ? (totalCost / revenue * 100).toFixed(1) : 0;
            document.getElementById('totalCostPercent').textContent = `${totalCostPercent}%`;
            
            const netProfitPercent = revenue > 0 ? (netProfit / revenue * 100).toFixed(1) : 0;
            document.getElementById('netProfitPercent').textContent = `${netProfitPercent}%`;
            
            // Update profit chart
            updateProfitChart();
        }

        // Chart initialization
        function initializeCharts() {
            // Finance chart
            const financeCtx = document.getElementById('financeChart');
            if (!financeCtx) return;
            
            const financeCanvas = financeCtx.getContext('2d');
            window.financeChart = new Chart(financeCanvas, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pemasukan',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Pengeluaran',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Fluktuasi Keuangan'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Profit chart
            const profitCtx = document.getElementById('profitChart');
            if (!profitCtx) return;
            
            const profitCanvas = profitCtx.getContext('2d');
            window.profitChart = new Chart(profitCanvas, {
                type: 'bar',
                data: {
                    labels: ['Pendapatan Penjualan', 'Biaya Beli Barang', 'Biaya Operasional', 'Biaya Gaji', 'Biaya Utilitas', 'Biaya Lain-lain'],
                    datasets: [{
                        label: 'Jumlah (Rp)',
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#fd7e14', '#17a2b8', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Komposisi Biaya vs Pendapatan'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Update charts with initial data
            updateFinanceChart();
            updateProfitChart();
        }

        function updateFinanceChart() {
            if (!window.financeChart) return;
            
            const dates = [...new Set([...incomeRecords, ...expenseRecords].map(record => formatDate(record.date)))].sort();
            const incomes = dates.map(date => 
                incomeRecords.filter(record => formatDate(record.date) === date)
                    .reduce((sum, record) => sum + record.amount, 0)
            );
            const expenses = dates.map(date => 
                expenseRecords.filter(record => formatDate(record.date) === date)
                    .reduce((sum, record) => sum + record.amount, 0)
            );
            
            window.financeChart.data.labels = dates;
            window.financeChart.data.datasets[0].data = incomes;
            window.financeChart.data.datasets[1].data = expenses;
            window.financeChart.update();
        }

        function updateProfitChart() {
            if (!window.profitChart) return;
            
            const revenue = getTotalRevenue();
            const cogs = getCOGS();
            const operationalCost = expenseRecords.filter(exp => exp.type === 'operational').reduce((sum, exp) => sum + exp.amount, 0);
            const salaryCost = getSalaryCost();
            const utilityCost = getUtilityCost();
            const otherCost = expenseRecords.filter(exp => !['purchase', 'operational', 'salary', 'utility'].includes(exp.type)).reduce((sum, exp) => sum + exp.amount, 0);
            
            window.profitChart.data.datasets[0].data = [revenue, cogs, operationalCost, salaryCost, utilityCost, otherCost];
            window.profitChart.update();
        }

        // Additional functionality
        function toggleSupplierInput() {
            const supplierSelect = document.getElementById('supplierSelect');
            const supplierInput = document.getElementById('supplierInput');
            const toggleBtn = document.getElementById('toggleSupplierBtn');
            
            if (!supplierSelect || !supplierInput || !toggleBtn) return;
            
            if (supplierInput.classList.contains('hidden')) {
                // Switch to manual input
                supplierSelect.classList.add('hidden');
                supplierInput.classList.remove('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-list"></i> Pilih';
                supplierInput.focus();
            } else {
                // Switch back to select
                supplierSelect.classList.remove('hidden');
                supplierInput.classList.add('hidden');
                toggleBtn.innerHTML = '<i class="fas fa-edit"></i> Manual';
                supplierInput.value = '';
            }
        }

        function handleSupplierSelect() {
            const supplierSelect = document.getElementById('supplierSelect');
            if (supplierSelect && supplierSelect.value === 'other') {
                toggleSupplierInput();
            }
        }

        function updateSupplierSelect() {
            const supplierSelect = document.getElementById('supplierSelect');
            if (!supplierSelect) return;
            
            // Save current value
            const currentValue = supplierSelect.value;
            
            // Remove all options except the first and the "other" option
            while (supplierSelect.children.length > 2) {
                supplierSelect.removeChild(supplierSelect.lastChild);
            }
            
            // Add supplier options
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierSelect.appendChild(option);
            });
            
            // Restore previous value if it still exists
            if (suppliers.includes(currentValue)) {
                supplierSelect.value = currentValue;
            }
        }

        function checkExistingProduct() {
            const productName = document.getElementById('productName').value.trim();
            const productInfo = document.getElementById('productInfo');
            const existingProductInfo = document.getElementById('existingProductInfo');
            
            if (!productName || !productInfo || !existingProductInfo) {
                return;
            }
            
            if (!productName) {
                productInfo.classList.add('hidden');
                return;
            }
            
            // Check if product exists in inventory
            const existingProduct = inventory.find(item => 
                item.name.toLowerCase().includes(productName.toLowerCase())
            );
            
            if (existingProduct) {
                existingProductInfo.innerHTML = `
                    <strong>Produk ditemukan:</strong> ${existingProduct.name}<br>
                    <strong>Stok saat ini:</strong> ${existingProduct.stock} unit<br>
                    <strong>Harga beli terakhir:</strong> ${formatCurrency(existingProduct.buyPrice)}<br>
                    <strong>Harga jual saat ini:</strong> ${formatCurrency(existingProduct.sellPrice)}
                `;
                productInfo.classList.remove('hidden');
                
                // Auto-fill unit price with last purchase price
                document.getElementById('unitPrice').value = existingProduct.buyPrice;
            } else {
                // Check if there are recent POs for this product
                const recentPOs = purchaseOrders
                    .filter(po => po.product.toLowerCase().includes(productName.toLowerCase()))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (recentPOs.length > 0) {
                    const latestPO = recentPOs[0];
                    existingProductInfo.innerHTML = `
                        <strong>Produk belum ada di inventory, tetapi ada PO sebelumnya:</strong><br>
                        <strong>PO Terakhir:</strong> ${latestPO.poNumber} (${formatDate(latestPO.date)})<br>
                        <strong>Harga beli terakhir:</strong> ${formatCurrency(latestPO.price)}<br>
                        <strong>Supplier:</strong> ${latestPO.supplier}
                    `;
                    productInfo.classList.remove('hidden');
                    
                    // Auto-fill unit price with last PO price
                    document.getElementById('unitPrice').value = latestPO.price;
                } else {
                    productInfo.classList.add('hidden');
                }
            }
        }

        function updatePoStatus(poNumber) {
            const po = purchaseOrders.find(p => p.poNumber === poNumber);
            if (po) {
                po.status = 'completed';
                showNotification(`PO ${po.poNumber} telah dikonfirmasi`);
            }
        }

        function editProduct(id) {
            const product = inventory.find(p => p.id === id);
            if (product) {
                const newBuyPrice = prompt(`Edit harga beli untuk ${product.name}:`, product.buyPrice);
                const newSellPrice = prompt(`Edit harga jual untuk ${product.name}:`, product.sellPrice);
                
                if (newBuyPrice && !isNaN(newBuyPrice) && newSellPrice && !isNaN(newSellPrice)) {
                    product.buyPrice = parseFloat(newBuyPrice);
                    product.sellPrice = parseFloat(newSellPrice);
                    
                    showNotification(`Harga ${product.name} diperbarui`);
                }
            }
        }

        function deleteProduct(id) {
            const product = inventory.find(p => p.id === id);
            if (product) {
                const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus produk ${product.name}?`);
                if (confirmDelete) {
                    // Menggunakan filter untuk menghapus
                    const index = inventory.findIndex(p => p.id === id);
                    if (index !== -1) {
                        inventory.splice(index, 1);
                        showNotification(`Produk ${product.name} berhasil dihapus`);
                    }
                }
            }
        }

        function deleteSalesTransaction(id) {
            const sale = salesTransactions.find(s => s.id === id);
            if (sale) {
                const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus transaksi penjualan ini?`);
                if (confirmDelete) {
                    // Restore stock for all items in the transaction
                    sale.items.forEach(item => {
                        const product = inventory.find(p => p.name === item.product);
                        if (product) {
                            product.stock += item.quantity;
                        }
                    });
                    
                    // Remove the transaction
                    const index = salesTransactions.findIndex(s => s.id === id);
                    if (index !== -1) {
                        salesTransactions.splice(index, 1);
                        
                        // Remove corresponding income record
                        const incomeIndex = incomeRecords.findIndex(inc => 
                            inc.description.includes(sale.items.map(item => item.product).join(','))
                        );
                        if (incomeIndex !== -1) {
                            incomeRecords.splice(incomeIndex, 1);
                        }
                        
                        showNotification('Transaksi penjualan berhasil dihapus');
                    }
                }
            }
        }

        function deleteSupplier(supplierName) {
            // Check if supplier has active POs
            const activePOs = purchaseOrders.filter(po => po.supplier === supplierName && po.status === 'pending');
            
            if (activePOs.length > 0) {
                showNotification(`Tidak dapat menghapus supplier ${supplierName} karena masih memiliki PO aktif!`, true);
                return;
            }
            
            const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus supplier ${supplierName}?`);
            if (confirmDelete) {
                const index = suppliers.findIndex(s => s === supplierName);
                if (index !== -1) {
                    suppliers.splice(index, 1);
                    showNotification(`Supplier ${supplierName} berhasil dihapus`);
                }
            }
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                const newFullName = prompt(`Edit nama lengkap untuk ${user.username}:`, user.fullName);
                const newRole = prompt(`Edit role untuk ${user.username} (owner/kasir/manager):`, user.role);
                const newStatus = prompt(`Edit status untuk ${user.username} (active/inactive):`, user.status);
                
                if (newFullName && newRole && newStatus) {
                    user.fullName = newFullName;
                    user.role = newRole;
                    user.status = newStatus;
                    
                    showNotification(`User ${user.username} berhasil diperbarui`);
                }
            }
        }

        function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                // Prevent deleting current user
                if (currentUser && currentUser.id === id) {
                    showNotification('Tidak dapat menghapus user yang sedang login!', true);
                    return;
                }
                
                const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus user ${user.fullName}?`);
                if (confirmDelete) {
                    const index = users.findIndex(u => u.id === id);
                    if (index !== -1) {
                        users.splice(index, 1);
                        showNotification(`User ${user.fullName} berhasil dihapus`);
                    }
                }
            }
        }

        function editCost(costType) {
            let currentValue = 0;
            let costName = '';
            
            switch(costType) {
                case 'cogs':
                    currentValue = getCOGS();
                    costName = 'Biaya Beli Barang';
                    break;
                case 'operational':
                    currentValue = expenseRecords.filter(exp => exp.type === 'operational').reduce((sum, exp) => sum + exp.amount, 0);
                    costName = 'Biaya Operasional';
                    break;
                case 'salary':
                    currentValue = getSalaryCost();
                    costName = 'Biaya Gaji Karyawan';
                    break;
                case 'utility':
                    currentValue = getUtilityCost();
                    costName = 'Biaya Utilitas';
                    break;
                case 'other':
                    currentValue = expenseRecords.filter(exp => !['purchase', 'operational', 'salary', 'utility'].includes(exp.type)).reduce((sum, exp) => sum + exp.amount, 0);
                    costName = 'Biaya Lain-lain';
                    break;
            }
            
            const newValue = prompt(`Edit ${costName}:`, currentValue);
            
            if (newValue && !isNaN(newValue)) {
                const amount = parseFloat(newValue);
                
                // Update the corresponding records
                switch(costType) {
                    case 'cogs':
                        expenseRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'purchase',
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                    case 'operational':
                        expenseRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'operational',
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                    case 'salary':
                        expenseRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'salary',
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                    case 'utility':
                        utilityRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'other',
                            period: new Date().toISOString().slice(0, 7),
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                    case 'other':
                        expenseRecords.push({
                            id: Date.now(),
                            date: new Date(),
                            type: 'other',
                            amount: amount - currentValue,
                            description: `Penyesuaian ${costName}`
                        });
                        break;
                }
                
                showNotification(`${costName} berhasil diperbarui`);
            }
        }

        // Search functionality
        function searchTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            });
        }

        // Export to Excel - Cek role user
        function exportToExcel() {
            // Cek apakah user memiliki akses
            if (!currentUser) {
                showNotification('Harap login terlebih dahulu!', true);
                return;
            }
            
            // Semua role bisa export Excel
            try {
                // Create workbook
                const workbook = XLSX.utils.book_new();
                
                // Worksheet untuk Purchase Orders
                const poData = purchaseOrders.map(po => ({
                    'No. PO': po.poNumber,
                    'Tanggal': formatDate(po.date),
                    'Produk': po.product,
                    'Supplier': po.supplier,
                    'Kuantitas': po.quantity,
                    'Harga Satuan': po.price,
                    'Total': po.total,
                    'Status': po.status === 'pending' ? 'Menunggu' : 'Selesai'
                }));
                if (poData.length > 0) {
                    const poWorksheet = XLSX.utils.json_to_sheet(poData);
                    XLSX.utils.book_append_sheet(workbook, poWorksheet, 'Purchase Orders');
                }
                
                // Worksheet untuk Inventory
                const inventoryData = inventory.map(item => ({
                    'Produk': item.name,
                    'Stok': item.stock,
                    'Harga Beli': item.buyPrice,
                    'Harga Jual': item.sellPrice,
                    'Status': item.stock <= 10 ? 'Kosong' : (item.stock <= 20 ? 'Stok Rendah' : 'Tersedia')
                }));
                if (inventoryData.length > 0) {
                    const inventoryWorksheet = XLSX.utils.json_to_sheet(inventoryData);
                    XLSX.utils.book_append_sheet(workbook, inventoryWorksheet, 'Persediaan');
                }
                
                // Worksheet untuk Penjualan
                const salesData = salesTransactions.map(sale => ({
                    'Tanggal': formatDate(sale.date),
                    'Produk': sale.items.map(item => item.product).join(', '),
                    'Jumlah Total': sale.items.reduce((sum, item) => sum + item.quantity, 0),
                    'Total Penjualan': sale.total,
                    'Status': 'Selesai'
                }));
                if (salesData.length > 0) {
                    const salesWorksheet = XLSX.utils.json_to_sheet(salesData);
                    XLSX.utils.book_append_sheet(workbook, salesWorksheet, 'Penjualan');
                }
                
                // Worksheet untuk Keuangan
                const totalIncome = incomeRecords.reduce((sum, inc) => sum + inc.amount, 0);
                const totalExpense = expenseRecords.reduce((sum, exp) => sum + exp.amount, 0);
                const totalUtility = utilityRecords.reduce((sum, util) => sum + util.amount, 0);
                const cashBalance = totalIncome - totalExpense - totalUtility;
                
                const financeData = [
                    { 'Jenis': 'Total Pemasukan', 'Jumlah': totalIncome },
                    { 'Jenis': 'Total Pengeluaran', 'Jumlah': totalExpense },
                    { 'Jenis': 'Total Biaya Utilitas', 'Jumlah': totalUtility },
                    { 'Jenis': 'Saldo Kas', 'Jumlah': cashBalance },
                    { 'Jenis': 'Piutang Pelanggan', 'Jumlah': getTotalReceivables() },
                    { 'Jenis': 'Hutang Supplier', 'Jumlah': getTotalPayables() }
                ];
                const financeWorksheet = XLSX.utils.json_to_sheet(financeData);
                XLSX.utils.book_append_sheet(workbook, financeWorksheet, 'Keuangan');
                
                // Save the workbook
                const today = new Date().toISOString().split('T')[0];
                XLSX.writeFile(workbook, `laporan-toko-${today}.xlsx`);
                
                showNotification('Data berhasil diexport ke Excel');
            } catch (error) {
                showNotification('Error saat export ke Excel: ' + error.message, true);
            }
        }

        // Export/Import functionality JSON - Cek role user
        function exportData() {
            // Hanya owner yang bisa export JSON
            if (!currentUser || currentUser.role !== 'owner') {
                showNotification('Hanya owner yang dapat melakukan export data lengkap!', true);
                return;
            }
            
            const data = {
                purchaseOrders,
                inventory,
                salesTransactions,
                incomeRecords,
                expenseRecords,
                utilityRecords,
                suppliers,
                users,
                exportDate: new Date()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `toko-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Data berhasil diexport ke JSON');
        }

        function importData(event) {
            // Hanya owner yang bisa import JSON
            if (!currentUser || currentUser.role !== 'owner') {
                showNotification('Hanya owner yang dapat melakukan import data!', true);
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (data.purchaseOrders && data.inventory && data.salesTransactions) {
                        // Mengganti data arrays dengan data baru
                        purchaseOrders.splice(0, purchaseOrders.length, ...data.purchaseOrders);
                        inventory.splice(0, inventory.length, ...data.inventory);
                        salesTransactions.splice(0, salesTransactions.length, ...data.salesTransactions);
                        
                        if (data.incomeRecords) incomeRecords.splice(0, incomeRecords.length, ...data.incomeRecords);
                        if (data.expenseRecords) expenseRecords.splice(0, expenseRecords.length, ...data.expenseRecords);
                        if (data.utilityRecords) utilityRecords.splice(0, utilityRecords.length, ...data.utilityRecords);
                        if (data.suppliers) suppliers.splice(0, suppliers.length, ...data.suppliers);
                        if (data.users) users.splice(0, users.length, ...data.users);
                        
                        showNotification('Data berhasil diimpor');
                    } else {
                        showNotification('Format file tidak valid', true);
                    }
                } catch (error) {
                    showNotification('Error membaca file: ' + error.message, true);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Auto-save functionality
        function autoSave() {
            const data = {
                purchaseOrders,
                inventory,
                salesTransactions,
                incomeRecords,
                expenseRecords,
                utilityRecords,
                suppliers,
                users,
                lastSave: new Date()
            };
            
            localStorage.setItem('tokoAppData', JSON.stringify(data));
        }

        function loadAutoSave() {
            const savedData = localStorage.getItem('tokoAppData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // Only load if data is recent (within 7 days)
                    const saveDate = new Date(data.lastSave);
                    const daysDiff = (new Date() - saveDate) / (1000 * 60 * 60 * 24);
                    
                    if (daysDiff < 7) {
                        // Mengganti data arrays dengan data yang disimpan
                        if (data.purchaseOrders) purchaseOrders.splice(0, purchaseOrders.length, ...data.purchaseOrders);
                        if (data.inventory) inventory.splice(0, inventory.length, ...data.inventory);
                        if (data.salesTransactions) salesTransactions.splice(0, salesTransactions.length, ...data.salesTransactions);
                        if (data.incomeRecords) incomeRecords.splice(0, incomeRecords.length, ...data.incomeRecords);
                        if (data.expenseRecords) expenseRecords.splice(0, expenseRecords.length, ...data.expenseRecords);
                        if (data.utilityRecords) utilityRecords.splice(0, utilityRecords.length, ...data.utilityRecords);
                        if (data.suppliers) suppliers.splice(0, suppliers.length, ...data.suppliers);
                        if (data.users) users.splice(0, users.length, ...data.users);
                        
                        showNotification('Data sebelumnya berhasil dimuat');
                    }
                } catch (error) {
                    console.log('Tidak ada data tersimpan atau data korup');
                }
            }
        }

        // Set up auto-save interval
        setInterval(autoSave, 30000);

        // Responsive design
        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (window.innerWidth < 768) {
                sidebar.classList.add('hidden');
                mainContent.classList.add('expanded');
            } else {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('expanded');
            }
        }

        window.addEventListener('resize', handleResize);

        // Dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            showNotification('Mode ' + (document.body.classList.contains('dark-mode') ? 'gelap' : 'terang') + ' diaktifkan');
        }

        // Load dark mode preference
        function loadDarkModePreference() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S for save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                autoSave();
                showNotification('Data disimpan');
            }
            
            // Escape to clear transaction
            if (e.key === 'Escape') {
                if (currentTransactionItems.length > 0) {
                    clearTransaction();
                }
            }
        });

        // PERBAIKAN: Update all statistics - Lebih efisien
        function updateAllStats() {
            // Stats sudah diupdate otomatis oleh observer
            // Update charts dan tabel saja
            updateFinanceChart();
            updateProfitChart();
            
            // Update tables
            updatePoTable();
            updateStockTable();
            updateSalesTable();
            updateSupplierTable();
            updateUsersTable();
            
            // Update dropdowns
            populateProductSelect();
            updatePoSelect(); // PERBAIKAN: Pastikan dropdown PO ter-update
            updateSupplierSelect();
        }

        // Purchase stats - Dipanggil oleh observer
        function updatePurchaseStats() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyPurchases = purchaseOrders.filter(po => {
                const poDate = new Date(po.date);
                return poDate.getMonth() === currentMonth && poDate.getFullYear() === currentYear;
            });
            
            const totalSpent = monthlyPurchases.reduce((sum, po) => sum + po.total, 0);
            const totalItems = purchaseOrders.reduce((sum, po) => sum + po.quantity, 0);
            
            document.getElementById('totalPurchaseMonth').textContent = formatCurrency(totalSpent);
            document.getElementById('totalPOItems').textContent = totalItems;
            document.getElementById('activeSuppliers').textContent = suppliers.length;
        }

        // Inventory stats - Dipanggil oleh observer
        function updateInventoryStats() {
            const totalItems = inventory.length;
            const lowStockCount = inventory.filter(item => item.stock <= 10).length;
            const totalValue = inventory.reduce((sum, item) => sum + (item.stock * item.buyPrice), 0);
            
            document.getElementById('totalInventoryItems').textContent = totalItems;
            document.getElementById('lowStockItems').textContent = lowStockCount;
            document.getElementById('totalInventoryValue').textContent = formatCurrency(totalValue);
            
            // Update dropdown produk
            populateProductSelect();
        }

        // Sales stats - Dipanggil oleh observer
        function updateSalesStats() {
            const today = new Date().toDateString();
            const todaySales = salesTransactions.filter(sale => new Date(sale.date).toDateString() === today);
            const totalToday = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            
            // Get unique customers (for demo, we'll use transaction count)
            const uniqueCustomers = salesTransactions.length;
            
            document.getElementById('todayTransactions').textContent = todaySales.length;
            document.getElementById('todaySales').textContent = formatCurrency(totalToday);
            document.getElementById('activeCustomers').textContent = uniqueCustomers;
        }

        // User stats - Dipanggil oleh observer
        function updateUserStats() {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active').length;
            const adminUsers = users.filter(user => user.role === 'owner').length;
            
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('adminUsers').textContent = adminUsers;
        }

        // Table updates - Lebih efisien
        function updatePoTable() {
            const tbody = document.querySelector('#poTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            purchaseOrders.forEach(po => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${po.poNumber}</td>
                    <td>${formatDate(po.date)}</td>
                    <td>${po.product}</td>
                    <td>${po.supplier}</td>
                    <td>${po.quantity}</td>
                    <td>${formatCurrency(po.price)}</td>
                    <td>${formatCurrency(po.total)}</td>
                    <td><span class="status-badge status-${po.status}">${po.status === 'pending' ? 'Menunggu' : 'Selesai'}</span></td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="updatePoStatus('${po.poNumber}')">Konfirmasi</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStockTable() {
            const tbody = document.querySelector('#stockTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            inventory.forEach(item => {
                const statusClass = item.stock <= 10 ? 'status-out' : (item.stock <= 20 ? 'status-low' : 'status-available');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.stock}</td>
                    <td>${formatCurrency(item.buyPrice)}</td>
                    <td>${formatCurrency(item.sellPrice)}</td>
                    <td><span class="status-badge ${statusClass}">${getStatusText(statusClass)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-small" onclick="editProduct(${item.id})">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteProduct(${item.id})">Hapus</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSalesTable() {
            const tbody = document.querySelector('#salesTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            salesTransactions.forEach(sale => {
                const row = document.createElement('tr');
                
                // Create base row content
                let rowContent = `
                    <td>${formatDate(sale.date)}</td>
                    <td>${sale.items.map(item => item.product).join(', ')}</td>
                    <td>${sale.items.reduce((sum, item) => sum + item.quantity, 0)}</td>
                    <td>${formatCurrency(sale.total)}</td>
                    <td><span class="status-badge status-completed">Selesai</span></td>
                `;
                
                // Add delete button only for owner
                if (currentUser && currentUser.role === 'owner') {
                    rowContent += `<td>
                        <button class="btn btn-danger btn-small" onclick="deleteSalesTransaction(${sale.id})">Hapus</button>
                    </td>`;
                }
                
                row.innerHTML = rowContent;
                tbody.appendChild(row);
            });
        }

        function updateSupplierTable() {
            const tbody = document.querySelector('#supplierTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            suppliers.forEach(supplier => {
                const supplierPOs = purchaseOrders.filter(po => po.supplier === supplier);
                const totalPOs = supplierPOs.length;
                const totalValue = supplierPOs.reduce((sum, po) => sum + po.total, 0);
                const activePOs = supplierPOs.filter(po => po.status === 'pending').length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier}</td>
                    <td>${totalPOs}</td>
                    <td>${formatCurrency(totalValue)}</td>
                    <td><span class="status-badge ${activePOs > 0 ? 'status-pending' : 'status-completed'}">${activePOs > 0 ? 'Aktif' : 'Selesai'}</span></td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="deleteSupplier('${supplier}')">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateUsersTable() {
            const tbody = document.querySelector('#usersTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.fullName}</td>
                    <td>${user.username}</td>
                    <td><span class="user-role-badge role-${user.role}">${user.role}</span></td>
                    <td><span class="status-badge ${user.status === 'active' ? 'status-available' : 'status-out'}">${user.status === 'active' ? 'Aktif' : 'Nonaktif'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-small" onclick="editUser(${user.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Notification system
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            text.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            sidebar.classList.toggle('hidden');
            mainContent.classList.toggle('expanded');
        }

        // Setup UI based on user role - MODIFIKASI: Menambahkan kontrol untuk export/import
        function setupUserInterface() {
            // Kontrol untuk section export/import di sidebar
            const ownerExportSection = document.getElementById('ownerExportSection');
            
            // Hide owner export section by default
            ownerExportSection.classList.add('hidden');
            
            // Show tabs based on user role
            if (currentUser.role === 'kasir') {
                // Kasir tidak bisa akses export/import JSON
                ownerExportSection.classList.add('hidden');
                
                // Show only sales tab
                showTab('sales');
            } else if (currentUser.role === 'owner') {
                // Owner bisa akses semua fitur export/import
                ownerExportSection.classList.remove('hidden');
            } else if (currentUser.role === 'manager') {
                // Manager tidak bisa akses export/import JSON
                ownerExportSection.classList.add('hidden');
            }
        }

        // Tab switching functionality - DIPERBAIKI
        function showTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            sidebarItems.forEach(item => item.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            
            // Set active state for sidebar item
            const sidebarItem = document.querySelector(`.sidebar-item[onclick="showTab('${tabId}')"]`);
            if (sidebarItem) {
                sidebarItem.classList.add('active');
            }
            
            // Refresh data when switching tabs - DIPERBAIKI
            refreshActiveTab(tabId);
        }

        // Sistem Auto-Refresh untuk Dashboard Realtime
        function startAutoRefresh() {
            // Hentikan interval sebelumnya jika ada
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Refresh setiap 3 detik
            autoRefreshInterval = setInterval(() => {
                const activeTab = document.querySelector('.tab-content.active').id;
                refreshActiveTab(activeTab);
            }, 3000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        function refreshActiveTab(tabId) {
            switch(tabId) {
                case 'purchase':
                    updatePoTable();
                    updateSupplierTable();
                    break;
                case 'inventory':
                    updateStockTable();
                    break;
                case 'sales':
                    updateSalesTable();
                    updateTransactionDetails();
                    break;
                case 'finance':
                    updateFinanceChart();
                    break;
                case 'profit':
                    calculateProfit();
                    updateProfitChart();
                    break;
                case 'users':
                    updateUsersTable();
                    break;
            }
        }
    </script>
</body>
</html>
